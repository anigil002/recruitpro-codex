<!DOCTYPE html>
<html class="dark" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>RecruitPro - Settings</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script defer src="./scripts/init-backend.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
      rel="stylesheet"
    />
    <script id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#2563EB",
              "background-light": "#F8FAFC",
              "background-dark": "#0F172A",
              success: "#10B981",
              error: "#EF4444",
              warning: "#F59E0B",
              "slate-50": "#F8FAFC",
              "slate-100": "#F1F5F9",
              "slate-200": "#E2E8F0",
              "slate-300": "#CBD5E1",
              "slate-400": "#94A3B8",
              "slate-500": "#64748B",
              "slate-600": "#475569",
              "slate-700": "#334155",
              "slate-800": "#1E293B",
              "slate-900": "#0F172A",
            },
            fontFamily: {
              display: ["Inter", "sans-serif"],
            },
            borderRadius: {
              DEFAULT: "0.5rem",
              lg: "0.75rem",
              xl: "1rem",
              full: "9999px",
            },
          },
        },
      };
    </script>
    <style>
      .material-symbols-outlined {
        font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 24;
        font-size: 20px;
      }
    </style>
  </head>
  <body
    class="bg-background-light font-display text-slate-800 dark:bg-background-dark dark:text-slate-200"
  >
    <div class="flex min-h-screen w-full">
      <!-- SideNavBar -->
      <aside
        class="flex w-64 flex-col border-r border-slate-200 bg-white p-4 dark:border-slate-800 dark:bg-slate-900"
      >
        <div class="flex flex-col gap-4">
          <div class="flex items-center gap-3 px-2">
            <div
              class="size-10 rounded-full bg-cover bg-center bg-no-repeat"
              data-alt="RecruitPro company logo"
              style="background-image: url('{{ sidebar.logo_url }}');"
            ></div>
            <div class="flex flex-col">
              <h1 class="text-base font-semibold leading-normal text-slate-900 dark:text-white">
                {{ sidebar.workspace_name }}
              </h1>
              <p class="text-sm font-normal leading-normal text-slate-500 dark:text-slate-400">
                {{ sidebar.workspace_context }}
              </p>
            </div>
          </div>
          <nav class="mt-4 flex flex-col gap-1">
            {% for item in sidebar.menu %}
            <a
              class="flex items-center gap-3 rounded px-3 py-2 {{ 'bg-primary/10 text-primary dark:bg-primary/20' if item.active else 'text-slate-600 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-800' }}"
              href="{{ item.href }}"
            >
              <span class="material-symbols-outlined" {% if item.icon_filled %}style="font-variation-settings: 'FILL' 1;"{% endif %}>{{ item.icon }}</span>
              <p class="text-sm font-medium leading-normal">{{ item.label }}</p>
            </a>
            {% endfor %}
          </nav>
        </div>
        <div class="mt-auto flex flex-col gap-1">
          {% for item in sidebar.secondary_menu %}
          <a
            class="flex items-center gap-3 rounded px-3 py-2 text-slate-600 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-800"
            href="{{ item.href }}"
          >
            <span class="material-symbols-outlined">{{ item.icon }}</span>
            <p class="text-sm font-medium leading-normal">{{ item.label }}</p>
          </a>
          {% endfor %}
        </div>
      </aside>
      <!-- Main Content -->
      <main class="flex-1">
        <div class="mx-auto max-w-4xl p-6 lg:p-10">
          <!-- PageHeading -->
          <header>
            <h1 class="text-4xl font-black leading-tight tracking-[-0.033em] text-slate-900 dark:text-white">
              Settings
            </h1>
          </header>
          <div class="mt-8 flex flex-col gap-8">
            <!-- SectionHeader -->
            <h2 class="text-[22px] font-bold leading-tight tracking-[-0.015em] text-slate-900 dark:text-white">
              API Keys Management
            </h2>
            <!-- Gemini API Card -->
            <section
              class="flex flex-col gap-5 rounded-lg border border-slate-200 bg-white p-6 dark:border-slate-800 dark:bg-slate-900"
            >
              <div class="flex items-center justify-between">
                <h3 class="text-lg font-bold leading-tight tracking-[-0.015em] text-slate-900 dark:text-white">
                  Gemini API
                </h3>
                {% if gemini.configured %}
                <div class="flex items-center gap-2 text-sm font-medium text-success">
                  <span class="material-symbols-outlined text-base" style="font-variation-settings: 'FILL' 1;">check_circle</span>
                  <span>Connected</span>
                </div>
                {% else %}
                <div class="flex items-center gap-2 text-sm font-medium text-slate-500 dark:text-slate-400">
                  <span class="material-symbols-outlined text-base">help</span>
                  <span>Not Configured</span>
                </div>
                {% endif %}
              </div>
              <div class="flex flex-col gap-1.5">
                <label
                  class="text-sm font-medium text-slate-700 dark:text-slate-300"
                  for="gemini-api"
                  >Gemini API Key</label
                >
                <div class="relative flex w-full items-stretch">
                  <input
                    class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded rounded-r-none border border-slate-300 border-r-0 bg-transparent px-3 text-sm font-normal leading-normal text-slate-900 focus:border-primary/50 focus:outline-0 focus:ring-2 focus:ring-primary/50 dark:border-slate-700 dark:text-white dark:focus:border-primary/50 dark:focus:ring-primary/50 dark:placeholder:text-slate-500"
                    id="gemini-api"
                    name="gemini_api_key"
                    type="password"
                    value="{{ gemini.value }}"
                    placeholder="Enter your Gemini API key"
                  />
                  <button
                    class="toggle-visibility flex items-center justify-center rounded-r border border-l-0 border-slate-300 bg-transparent p-2 text-slate-500 hover:bg-slate-50 dark:border-slate-700 dark:text-slate-400 dark:hover:bg-slate-800"
                    type="button"
                    data-target="gemini-api"
                  >
                    <span class="material-symbols-outlined">visibility</span>
                  </button>
                </div>
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Your API key is stored securely and encrypted.
                  <a class="text-primary hover:underline" href="{{ gemini.learn_more_url }}">Learn how to get your key.</a>
                </p>
              </div>
              <div class="flex items-center justify-end border-t border-slate-200 pt-4 dark:border-slate-800">
                <button
                  class="inline-flex items-center justify-center rounded px-4 py-2 text-sm font-semibold text-primary hover:bg-primary/10 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/50"
                  type="button"
                >
                  Test Connection
                </button>
              </div>
            </section>
            <!-- Google Custom Search Card -->
            <section
              class="flex flex-col gap-5 rounded-lg border border-slate-200 bg-white p-6 dark:border-slate-800 dark:bg-slate-900"
            >
              <div class="flex items-center justify-between">
                <h3 class="text-lg font-bold leading-tight tracking-[-0.015em] text-slate-900 dark:text-white">
                  Google Custom Search
                </h3>
                {% if google.configured %}
                <div class="flex items-center gap-2 text-sm font-medium text-success">
                  <span class="material-symbols-outlined text-base" style="font-variation-settings: 'FILL' 1;">check_circle</span>
                  <span>Connected</span>
                </div>
                {% else %}
                <div class="flex items-center gap-2 text-sm font-medium text-slate-500 dark:text-slate-400">
                  <span class="material-symbols-outlined text-base">help</span>
                  <span>Not Configured</span>
                </div>
                {% endif %}
              </div>
              <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                <div class="flex flex-col gap-1.5">
                  <label
                    class="text-sm font-medium text-slate-700 dark:text-slate-300"
                    for="google-api"
                    >Google API Key</label
                  >
                  <div class="relative flex w-full items-stretch">
                    <input
                      class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded rounded-r-none border border-slate-300 border-r-0 bg-transparent px-3 text-sm font-normal leading-normal text-slate-900 focus:border-primary/50 focus:outline-0 focus:ring-2 focus:ring-primary/50 dark:border-slate-700 dark:text-white dark:focus:border-primary/50 dark:focus:ring-primary/50 dark:placeholder:text-slate-500"
                      id="google-api"
                      name="google_api_key"
                      type="password"
                      value="{{ google.value }}"
                      placeholder="Enter your Google API key"
                    />
                    <button
                      class="toggle-visibility flex items-center justify-center rounded-r border border-l-0 border-slate-300 bg-transparent p-2 text-slate-500 hover:bg-slate-50 dark:border-slate-700 dark:text-slate-400 dark:hover:bg-slate-800"
                      type="button"
                      data-target="google-api"
                    >
                      <span class="material-symbols-outlined">visibility_off</span>
                    </button>
                  </div>
                </div>
                <div class="flex flex-col gap-1.5">
                  <label
                    class="text-sm font-medium text-slate-700 dark:text-slate-300"
                    for="search-engine-id"
                    >Custom Search Engine ID</label
                  >
                  <div class="relative flex w-full items-stretch">
                    <input
                      class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded border border-slate-300 bg-transparent px-3 text-sm font-normal leading-normal text-slate-900 focus:border-primary/50 focus:outline-0 focus:ring-2 focus:ring-primary/50 dark:border-slate-700 dark:text-white dark:focus:border-primary/50 dark:focus:ring-primary/50 dark:placeholder:text-slate-500"
                      id="search-engine-id"
                      name="google_cse_id"
                      type="text"
                      value="{{ google.search_engine_id }}"
                      placeholder="Enter your Search Engine ID"
                    />
                  </div>
                </div>
              </div>
              <p class="text-xs text-slate-500 dark:text-slate-400">
                Find your API key and Search Engine ID in the
                <a class="text-primary hover:underline" href="{{ google.learn_more_url }}">Google Cloud Console.</a>
              </p>
              <div class="flex items-center justify-end border-t border-slate-200 pt-4 dark:border-slate-800">
                <button
                  class="inline-flex items-center justify-center rounded px-4 py-2 text-sm font-semibold text-primary hover:bg-primary/10 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/50"
                  type="button"
                >
                  Test Connection
                </button>
              </div>
            </section>
            <h2 class="text-[22px] font-bold leading-tight tracking-[-0.015em] text-slate-900 dark:text-white">
              Database Administration
            </h2>
            <section class="flex flex-col gap-5 rounded-lg border border-slate-200 bg-white p-6 dark:border-slate-800 dark:bg-slate-900">
              <div class="flex flex-col gap-2">
                <div class="flex flex-wrap items-center justify-between gap-3">
                  <h3 class="text-lg font-bold leading-tight tracking-[-0.015em] text-slate-900 dark:text-white">
                    Local SQLite Maintenance
                  </h3>
                  <p
                    class="text-xs font-medium text-slate-500 dark:text-slate-400"
                    id="database-admin-auth-status"
                  ></p>
                </div>
                <p class="text-sm text-slate-600 dark:text-slate-300">
                  Create secure backups, restore previous snapshots, and import legacy JSON exports directly from the desktop console.
                </p>
              </div>
              <div class="grid gap-5 md:grid-cols-2">
                <div class="flex flex-col gap-3 rounded-lg border border-slate-200 bg-slate-50/60 p-4 dark:border-slate-800 dark:bg-slate-900/50">
                  <div>
                    <h4 class="text-sm font-semibold text-slate-900 dark:text-white">Create Backup</h4>
                    <p class="text-xs text-slate-500 dark:text-slate-400">
                      Generate a timestamped copy of the local SQLite database before major changes or upgrades.
                    </p>
                  </div>
                  <button
                    class="inline-flex items-center justify-center rounded-lg bg-primary px-4 py-2 text-sm font-semibold text-white hover:bg-primary/90 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/50 focus-visible:ring-offset-2 disabled:opacity-50"
                    id="create-backup-button"
                    type="button"
                  >
                    Create Backup
                  </button>
                  <p class="text-xs font-medium text-slate-500 dark:text-slate-400" id="database-backup-status"></p>
                </div>
                <div class="flex flex-col gap-3 rounded-lg border border-slate-200 bg-slate-50/60 p-4 dark:border-slate-800 dark:bg-slate-900/50">
                  <div>
                    <h4 class="text-sm font-semibold text-slate-900 dark:text-white">Restore Backup</h4>
                    <p class="text-xs text-slate-500 dark:text-slate-400">
                      Select a backup file to replace the active database. The backend restarts automatically after a successful restore.
                    </p>
                  </div>
                  <button
                    class="inline-flex items-center justify-center rounded-lg bg-white px-4 py-2 text-sm font-semibold text-slate-700 ring-1 ring-inset ring-slate-300 hover:bg-slate-100 focus:outline-none dark:bg-slate-800 dark:text-slate-200 dark:ring-slate-700 dark:hover:bg-slate-700 disabled:opacity-50"
                    id="restore-backup-button"
                    type="button"
                  >
                    Restore Backup
                  </button>
                  <p class="text-xs font-medium text-slate-500 dark:text-slate-400" id="database-restore-status"></p>
                </div>
                <div class="md:col-span-2 flex flex-col gap-3 rounded-lg border border-slate-200 bg-white p-4 dark:border-slate-800 dark:bg-slate-900">
                  <div>
                    <h4 class="text-sm font-semibold text-slate-900 dark:text-white">JSON Migration</h4>
                    <p class="text-xs text-slate-500 dark:text-slate-400">
                      Import structured JSON exports of projects, positions, candidates, and documents. Existing records are updated automatically.
                    </p>
                  </div>
                  <input
                    accept=".json,application/json"
                    class="hidden"
                    id="json-migration-input"
                    type="file"
                  />
                  <div class="flex flex-wrap items-center gap-3">
                    <button
                      class="inline-flex items-center justify-center rounded-lg bg-white px-4 py-2 text-sm font-semibold text-slate-700 ring-1 ring-inset ring-slate-300 hover:bg-slate-100 focus:outline-none dark:bg-slate-800 dark:text-slate-200 dark:ring-slate-700 dark:hover:bg-slate-700 disabled:opacity-50"
                      id="choose-migration-file"
                      type="button"
                    >
                      Select JSON File
                    </button>
                    <span class="text-sm text-slate-500 dark:text-slate-400" id="json-migration-file-label">No file selected</span>
                  </div>
                  <div class="flex flex-wrap items-center gap-3">
                    <button
                      class="inline-flex items-center justify-center rounded-lg bg-primary px-4 py-2 text-sm font-semibold text-white hover:bg-primary/90 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/50 focus-visible:ring-offset-2 disabled:opacity-50"
                      id="run-migration-button"
                      type="button"
                      disabled
                    >
                      Import Data
                    </button>
                    <p class="text-xs font-medium text-slate-500 dark:text-slate-400" id="json-migration-status"></p>
                  </div>
                </div>
              </div>
            </section>
          </div>
          <footer class="mt-10 flex items-center justify-end gap-3 border-t border-slate-200 pt-6 dark:border-slate-800">
            <button
              class="inline-flex items-center justify-center rounded-lg bg-white px-4 py-2 text-sm font-semibold text-slate-700 ring-1 ring-inset ring-slate-300 hover:bg-slate-50 focus:outline-none dark:bg-slate-800 dark:text-slate-200 dark:ring-slate-700 dark:hover:bg-slate-700"
              type="button"
            >
              Cancel
            </button>
            <button
              class="inline-flex items-center justify-center rounded-lg bg-primary px-4 py-2 text-sm font-semibold text-white hover:bg-primary/90 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/50 focus-visible:ring-offset-2 disabled:opacity-50"
              type="button"
              disabled
            >
              Save Changes
            </button>
          </footer>
        </div>
      </main>
    </div>
    <script>
        const toggleButtons = document.querySelectorAll('.toggle-visibility');
        toggleButtons.forEach((button) => {
          button.addEventListener('click', () => {
            const targetId = button.getAttribute('data-target');
            const input = document.getElementById(targetId);
            if (!input) {
              return;
            }
            if (input.type === 'password') {
              input.type = 'text';
              button.querySelector('.material-symbols-outlined').textContent = 'visibility_off';
            } else {
              input.type = 'password';
              button.querySelector('.material-symbols-outlined').textContent = 'visibility';
            }
          });
        });

        const tonePalette = {
          success: '#10B981',
          error: '#EF4444',
          info: '#2563EB',
          muted: '',
        };

        const setStatusMessage = (element, message, tone = 'muted') => {
          if (!element) {
            return;
          }
          element.textContent = message || '';
          element.style.color = tonePalette[tone] ?? '';
        };

        const state = {
          backendUrl: window.backendBaseUrl || '',
          loadingMigration: false,
        };

        const adminStatusEl = document.getElementById('database-admin-auth-status');
        const backupStatusEl = document.getElementById('database-backup-status');
        const restoreStatusEl = document.getElementById('database-restore-status');
        const migrationStatusEl = document.getElementById('json-migration-status');
        const migrationFileLabel = document.getElementById('json-migration-file-label');
        const migrationFileInput = document.getElementById('json-migration-input');
        const chooseMigrationButton = document.getElementById('choose-migration-file');
        const runMigrationButton = document.getElementById('run-migration-button');
        const createBackupButton = document.getElementById('create-backup-button');
        const restoreBackupButton = document.getElementById('restore-backup-button');

        const ensureBackendUrl = async () => {
          if (state.backendUrl) {
            return state.backendUrl;
          }
          if (window.backendBaseUrl) {
            state.backendUrl = window.backendBaseUrl;
            return state.backendUrl;
          }
          if (window.electronAPI?.getBackendUrl) {
            try {
              const url = await window.electronAPI.getBackendUrl();
              if (url) {
                state.backendUrl = url;
                window.backendBaseUrl = url;
              }
            } catch (error) {
              console.warn('Failed to resolve backend URL for admin tools', error);
            }
          }
          return state.backendUrl || '';
        };

        const resolveApi = (base, path = '') => {
          if (!path) {
            return base;
          }
          if (path.startsWith('http://') || path.startsWith('https://')) {
            return path;
          }
          if (!base) {
            return path;
          }
          if (path.startsWith('/')) {
            return `${base}${path}`;
          }
          return `${base}/${path}`;
        };

        const authorizedRequest = async (path, options = {}) => {
          const token = sessionStorage.getItem('recruitproAccessToken');
          if (!token) {
            throw new Error('Sign in with an administrator or super administrator account to continue.');
          }

          const base = await ensureBackendUrl();
          const url = resolveApi(base, path);
          const headers = new Headers(options.headers || {});
          headers.set('Authorization', `Bearer ${token}`);

          const hasBody = Object.prototype.hasOwnProperty.call(options, 'body') && options.body !== null && options.body !== undefined;
          if (hasBody && !(options.body instanceof FormData) && !headers.has('Content-Type')) {
            headers.set('Content-Type', 'application/json');
          }

          const response = await fetch(url, {
            ...options,
            headers,
          });
          const rawText = await response.text();

          if (!response.ok) {
            throw new Error(rawText || `Request failed with status ${response.status}`);
          }

          if (!rawText) {
            return null;
          }

          try {
            return JSON.parse(rawText);
          } catch (error) {
            return rawText;
          }
        };

        const refreshMigrationButtonState = () => {
          if (!runMigrationButton) {
            return;
          }
          const token = sessionStorage.getItem('recruitproAccessToken');
          const hasFile = Boolean(migrationFileInput?.files?.length);
          runMigrationButton.disabled = !token || !hasFile || state.loadingMigration;
        };

        const updateAdminStatus = () => {
          const token = sessionStorage.getItem('recruitproAccessToken');
          if (!token) {
            setStatusMessage(
              adminStatusEl,
              'Sign in with an admin or super admin account to unlock database tools.',
              'info',
            );
          } else {
            setStatusMessage(adminStatusEl, 'Administrator session detected.', 'success');
          }
          refreshMigrationButtonState();
        };

        if (chooseMigrationButton && migrationFileInput) {
          chooseMigrationButton.addEventListener('click', () => {
            migrationFileInput.click();
          });
        }

        if (migrationFileInput) {
          migrationFileInput.addEventListener('change', () => {
            const file = migrationFileInput.files?.[0];
            if (file && migrationFileLabel) {
              const sizeKb = (file.size / 1024).toFixed(1);
              migrationFileLabel.textContent = `${file.name} (${sizeKb} KB)`;
            } else if (migrationFileLabel) {
              migrationFileLabel.textContent = 'No file selected';
            }
            setStatusMessage(migrationStatusEl, '');
            refreshMigrationButtonState();
          });
        }

        if (runMigrationButton && migrationFileInput) {
          runMigrationButton.addEventListener('click', async () => {
            const file = migrationFileInput.files?.[0];
            if (!file) {
              setStatusMessage(migrationStatusEl, 'Select a JSON export to import.', 'error');
              return;
            }

            try {
              state.loadingMigration = true;
              refreshMigrationButtonState();
              setStatusMessage(migrationStatusEl, 'Importing JSON data…', 'info');
              const fileText = await file.text();
              let parsed;
              try {
                parsed = JSON.parse(fileText);
              } catch (error) {
                throw new Error('The selected file is not valid JSON.');
              }

              const response = await authorizedRequest('/api/admin/migrate-from-json', {
                method: 'POST',
                body: JSON.stringify({
                  source_name: file.name,
                  data: parsed,
                }),
              });

              if (response?.summary) {
                const { summary } = response;
                const parts = [];
                if (summary.projects) {
                  parts.push(`Projects ${summary.projects.created ?? 0} created / ${summary.projects.updated ?? 0} updated`);
                }
                if (summary.positions) {
                  parts.push(`Positions ${summary.positions.created ?? 0} created / ${summary.positions.updated ?? 0} updated`);
                }
                if (summary.candidates) {
                  parts.push(`Candidates ${summary.candidates.created ?? 0} created / ${summary.candidates.updated ?? 0} updated`);
                }
                if (summary.documents) {
                  parts.push(`Documents ${summary.documents.created ?? 0} created / ${summary.documents.updated ?? 0} updated`);
                }
                const detail = parts.length ? ` ${parts.join(' • ')}` : '';
                setStatusMessage(migrationStatusEl, `Migration completed.${detail}`, 'success');
              } else {
                setStatusMessage(migrationStatusEl, 'Migration completed.', 'success');
              }
            } catch (error) {
              console.error('JSON migration failed', error);
              setStatusMessage(
                migrationStatusEl,
                error instanceof Error ? error.message : 'Unable to import JSON data.',
                'error',
              );
            } finally {
              state.loadingMigration = false;
              refreshMigrationButtonState();
            }
          });
        }

        if (!window.electronAPI?.database) {
          if (createBackupButton) {
            createBackupButton.disabled = true;
          }
          if (restoreBackupButton) {
            restoreBackupButton.disabled = true;
          }
          setStatusMessage(
            backupStatusEl,
            'Desktop database bridge unavailable in this environment.',
            'error',
          );
          setStatusMessage(
            restoreStatusEl,
            'Desktop database bridge unavailable in this environment.',
            'error',
          );
        } else {
          if (createBackupButton) {
            createBackupButton.addEventListener('click', async () => {
              try {
                createBackupButton.disabled = true;
                setStatusMessage(backupStatusEl, 'Creating backup…', 'info');
                let destination = '';
                if (window.electronAPI.dialog?.saveFile) {
                  const defaultName = `recruitpro-backup-${new Date().toISOString().slice(0, 10)}.db`;
                  const result = await window.electronAPI.dialog.saveFile({
                    title: 'Save RecruitPro backup',
                    defaultPath: defaultName,
                    filters: [{ name: 'SQLite database', extensions: ['db'] }],
                  });
                  if (result?.canceled) {
                    setStatusMessage(backupStatusEl, 'Backup cancelled.', 'muted');
                    return;
                  }
                  destination = result?.filePath || '';
                }
                const outcome = await window.electronAPI.database.backup(destination);
                const destinationPath = outcome?.destination || destination || 'default backup directory';
                setStatusMessage(
                  backupStatusEl,
                  `Backup saved to ${destinationPath}.`,
                  'success',
                );
              } catch (error) {
                console.error('Database backup failed', error);
                setStatusMessage(
                  backupStatusEl,
                  error instanceof Error ? error.message : 'Backup failed.',
                  'error',
                );
              } finally {
                createBackupButton.disabled = false;
              }
            });
          }

          if (restoreBackupButton) {
            restoreBackupButton.addEventListener('click', async () => {
              try {
                restoreBackupButton.disabled = true;
                setStatusMessage(restoreStatusEl, 'Select a backup file to restore…', 'info');
                let source = '';
                if (window.electronAPI.dialog?.openFile) {
                  const result = await window.electronAPI.dialog.openFile({
                    title: 'Select a RecruitPro backup',
                    filters: [{ name: 'SQLite database', extensions: ['db'] }],
                  });
                  if (result?.canceled || !result?.filePaths?.length) {
                    setStatusMessage(restoreStatusEl, 'Restore cancelled.', 'muted');
                    return;
                  }
                  source = result.filePaths[0];
                } else {
                  const manualPath = window.prompt('Enter the full path to the backup file you want to restore:');
                  if (!manualPath) {
                    setStatusMessage(restoreStatusEl, 'Restore cancelled.', 'muted');
                    return;
                  }
                  source = manualPath;
                }

                const outcome = await window.electronAPI.database.restore(source);
                const restoredTo = outcome?.restoredTo || 'active database';
                setStatusMessage(
                  restoreStatusEl,
                  `Database restored successfully. Live database: ${restoredTo}.`,
                  'success',
                );
              } catch (error) {
                console.error('Database restore failed', error);
                setStatusMessage(
                  restoreStatusEl,
                  error instanceof Error ? error.message : 'Restore failed.',
                  'error',
                );
              } finally {
                restoreBackupButton.disabled = false;
              }
            });
          }
        }

        updateAdminStatus();
        window.addEventListener('focus', updateAdminStatus);
    </script>
  </body>
</html>
