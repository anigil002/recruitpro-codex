<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>RecruitPro Complete ATS - AI-Powered Recruitment Platform</title>
    <!-- Cache buster: {{ cache_buster }} -->
	<!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/static/images/favicon.svg">
	<!-- Global Styles -->
    <link rel="stylesheet" href="/static/css/recruitpro-styles.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-dark: #062C3A;
            --lime: #ABC100;
            --gray-blue: #5D858B;
            --teal-dark: #00617E;
            --teal: #00A4A6;
            --light-blue: #97B8BB;
            --orange: #F4A41D;
            --purple: #71164C;
            --yellow: #E2EC57;
            --blue: #75A1D2;
            --navy: #344893;
            --green: #00A78B;
            --red: #C8313F;
            --white: #FFFFFF;
            --gray-light: #F5F5F7;
            --gray: #86868B;
            --black: #1D1D1F;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: var(--gray-light);
            color: var(--black);
            min-height: 100vh;
        }

        /* Layout Structure */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Enhanced Sidebar */
        .sidebar {
            width: 280px;
            background: var(--white);
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .sidebar.collapsed {
            transform: translateX(-280px);
        }

        .sidebar-header {
            padding: 24px 20px;
            background: linear-gradient(135deg, var(--navy), var(--primary-dark));
            color: var(--white);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 700;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--lime);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .nav-menu {
            flex: 1;
            overflow-y: auto;
            padding: 20px 0;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-section-title {
            padding: 0 20px;
            margin-bottom: 8px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--gray);
            letter-spacing: 0.5px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: var(--black);
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
        }

        .nav-item:hover {
            background: var(--gray-light);
            color: var(--teal);
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(0,167,139,0.1) 0%, transparent 100%);
            color: var(--green);
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--green);
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--red);
            color: var(--white);
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            margin-left: 280px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .main-content.expanded {
            margin-left: 0;
        }

        /* Top Bar */
        .topbar {
            background: var(--white);
            padding: 16px 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .topbar-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .menu-toggle {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gray-light);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
        }

        .search-bar {
            position: relative;
            width: 400px;
        }

        .search-input {
            width: 100%;
            padding: 10px 40px 10px 16px;
            border: 1px solid #e5e5e7;
            border-radius: 8px;
            font-size: 14px;
            background: var(--gray-light);
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .topbar-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gray-light);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
        }

        .notification-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            background: var(--red);
            border-radius: 50%;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .user-menu:hover {
            background: var(--gray-light);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--blue), var(--teal));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 600;
        }

        .user-info {
            display: none;
        }

        @media (min-width: 768px) {
            .user-info {
                display: block;
            }
        }

        .user-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--black);
        }

        .user-role {
            font-size: 12px;
            color: var(--gray);
        }

        /* Page Content */
        .page-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .page-header {
            margin-bottom: 24px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 8px;
        }

        .page-subtitle {
            font-size: 14px;
            color: var(--gray);
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            gap: 24px;
            margin-bottom: 24px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--white);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 16px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-icon.blue { background: rgba(117, 161, 210, 0.15); color: var(--blue); }
        .stat-icon.green { background: rgba(0, 167, 139, 0.15); color: var(--green); }
        .stat-icon.orange { background: rgba(244, 164, 29, 0.15); color: var(--orange); }
        .stat-icon.purple { background: rgba(113, 22, 76, 0.15); color: var(--purple); }
        .stat-icon.red { background: rgba(200, 49, 63, 0.15); color: var(--red); }
        .stat-icon.teal { background: rgba(0, 164, 166, 0.15); color: var(--teal); }

        .stat-content {
            flex: 1;
        }

        .stat-label {
            font-size: 12px;
            color: var(--gray);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--black);
            display: flex;
            align-items: baseline;
            gap: 8px;
        }

        .stat-change {
            font-size: 12px;
            font-weight: 500;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .stat-change.up {
            background: rgba(0, 167, 139, 0.1);
            color: var(--green);
        }

        .stat-change.down {
            background: rgba(200, 49, 63, 0.1);
            color: var(--red);
        }

        /* Pipeline Kanban */
        .pipeline-board {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding-bottom: 20px;
            margin-bottom: 24px;
        }

        .pipeline-column {
            min-width: 280px;
            background: var(--gray-light);
            border-radius: 12px;
            padding: 16px;
        }

        .pipeline-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .pipeline-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--black);
        }

        .pipeline-count {
            background: var(--white);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: var(--gray);
        }

        .candidate-card {
            background: var(--white);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: move;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .candidate-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: var(--teal);
        }

        .candidate-card.dragging {
            opacity: 0.5;
        }

        .candidate-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--black);
            margin-bottom: 4px;
        }

        .candidate-position {
            font-size: 12px;
            color: var(--gray);
            margin-bottom: 8px;
        }

        .candidate-tags {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .tag {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--gray-light);
            color: var(--gray);
        }

        /* Data Tables */
        .data-table-container {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 24px;
        }

        .table-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--black);
        }

        .table-actions {
            display: flex;
            gap: 12px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 12px;
            font-size: 12px;
            font-weight: 600;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #e5e5e7;
        }

        .data-table td {
            padding: 16px 12px;
            font-size: 14px;
            color: var(--black);
            border-bottom: 1px solid #f5f5f7;
        }

        .data-table tr:hover {
            background: var(--gray-light);
        }

        /* Forms */
        .form-container {
            background: var(--white);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--black);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e5e5e7;
            border-radius: 8px;
            font-size: 14px;
            background: var(--white);
            transition: border-color 0.2s;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--teal);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--teal);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--teal-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--gray-light);
            color: var(--black);
        }

        .btn-secondary:hover {
            background: #e5e5e7;
        }

        .btn-success {
            background: var(--green);
            color: var(--white);
        }

        .btn-danger {
            background: var(--red);
            color: var(--white);
        }

        .btn-warning {
            background: var(--orange);
            color: var(--white);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-lg {
            padding: 14px 28px;
            font-size: 16px;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border-radius: 16px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--black);
        }

        .modal-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gray-light);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
        }

        /* AI Analysis Modal Styles */
        .ai-analysis-modal .modal-content {
            max-width: 800px;
        }

        .analysis-summary {
            background: #E3F2FD;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid var(--blue);
        }

        .job-description-card {
            background: var(--gray-light);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--gray);
        }

        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .job-header h4 {
            margin: 0;
            color: var(--navy);
        }

        .confidence-badge {
            background: var(--green);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .job-details p {
            margin: 8px 0;
            font-size: 14px;
        }

        .positions-created {
            background: #E8F5E8;
            padding: 16px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid var(--green);
        }

        .positions-created h3 {
            color: var(--green);
            margin-top: 0;
        }

        .positions-created ul {
            margin: 12px 0;
            padding-left: 20px;
        }

        .positions-created em {
            color: #666;
            font-size: 14px;
        }

        .ai-notice {
            background: #FFF3E0;
            border: 1px solid #FFB74D;
            border-radius: 8px;
            padding: 12px;
            margin-top: 16px;
        }

        .ai-notice p {
            margin: 0;
            font-size: 14px;
            color: #E65100;
        }

        /* Charts Container */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .chart-container {
            background: var(--white);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--black);
        }

        /* Activity Feed */
        .activity-feed {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .activity-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-light);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gray-light);
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--black);
            margin-bottom: 4px;
        }

        .activity-description {
            font-size: 13px;
            color: var(--gray);
            margin-bottom: 4px;
        }

        .activity-time {
            font-size: 12px;
            color: var(--gray);
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--gray-light);
            border-top-color: var(--teal);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-280px);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .search-bar {
                width: 100%;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .pipeline-board {
                flex-direction: column;
            }

            .pipeline-column {
                min-width: 100%;
            }
        }

        /* Chatbot */
        .chatbot-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999;
        }

        .chatbot-button {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--teal);
            color: var(--white);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: transform 0.2s;
        }

        .chatbot-button:hover {
            transform: scale(1.1);
        }

        .chatbot-window {
            position: absolute;
            bottom: 70px;
            right: 0;
            width: 350px;
            height: 500px;
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            display: none;
            flex-direction: column;
        }

        .chatbot-window.active {
            display: flex;
        }

        .chatbot-header {
            padding: 16px;
            background: var(--teal);
            color: var(--white);
            border-radius: 12px 12px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chatbot-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }

        .chat-message {
            margin-bottom: 12px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .chat-message.user {
            flex-direction: row-reverse;
        }

        .chat-bubble {
            max-width: 70%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 14px;
        }

        .chat-message.bot .chat-bubble {
            background: var(--gray-light);
            color: var(--black);
        }

        .chat-message.user .chat-bubble {
            background: var(--teal);
            color: var(--white);
        }

        .chatbot-input {
            padding: 16px;
            border-top: 1px solid var(--gray-light);
            display: flex;
            gap: 8px;
        }

        .chatbot-input input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            font-size: 14px;
        }

        .chatbot-input button {
            padding: 8px 16px;
            background: var(--teal);
            color: var(--white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        /* Pipeline Page Styles */
        .pipeline-container {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding: 20px 0;
            min-height: 400px;
        }

        .pipeline-stage {
            flex: 1;
            min-width: 250px;
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .pipeline-stage h3 {
            margin-bottom: 12px;
            color: var(--primary-dark);
            font-size: 16px;
            font-weight: 600;
        }

        .stage-count {
            background: var(--teal);
            color: var(--white);
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 14px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 16px;
        }

        .candidates-list {
            min-height: 200px;
            border: 2px dashed var(--gray);
            border-radius: 8px;
            padding: 12px;
        }

        .pipeline-candidate {
            background: var(--gray-light);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pipeline-candidate:hover {
            background: var(--light-blue);
            transform: translateY(-2px);
        }

        .candidate-name {
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 4px;
        }

        .candidate-position {
            font-size: 12px;
            color: var(--gray);
        }

        /* Analytics Page Styles */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .analytics-card {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .analytics-card h4 {
            margin-bottom: 16px;
            color: var(--primary-dark);
            font-size: 16px;
            font-weight: 600;
        }

        .analytics-card > div {
            min-height: 200px;
            background: var(--gray-light);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray);
            font-style: italic;
        }

        .analytics-card > div::before {
            content: "Chart placeholder - Connect to analytics engine";
        }

        /* Document Upload Section Styles */
        .document-upload-section {
            background: var(--gray-light);
            border-radius: 8px;
            padding: 20px;
            border: 2px dashed var(--gray);
            margin-top: 8px;
        }

        .uploaded-documents {
            background: var(--white);
            border-radius: 8px;
            border: 1px solid var(--gray);
            padding: 12px;
            min-height: 60px;
        }

        .document-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: var(--gray-light);
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .document-item:last-child {
            margin-bottom: 0;
        }

        .document-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .document-icon {
            width: 32px;
            height: 32px;
            background: var(--teal);
            color: var(--white);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .document-details h4 {
            margin: 0;
            font-size: 14px;
            color: var(--primary-dark);
        }

        .document-details p {
            margin: 0;
            font-size: 12px;
            color: var(--gray);
        }

        .document-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
        }

        .empty-documents {
            text-align: center;
            color: var(--gray);
            font-style: italic;
            padding: 20px;
        }

        .project-item {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .project-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-dark);
            margin: 0;
        }

        .project-type {
            background: var(--teal);
            color: var(--white);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .project-documents-count {
            background: var(--orange);
            color: var(--white);
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 11px;
            margin-left: 8px;
        }

        /* Project Card Styles */
        .project-card {
            background: var(--white);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            border: 1px solid var(--gray-light);
            transition: box-shadow 0.2s, transform 0.2s;
        }

        .project-card:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }

        .project-info {
            flex: 1;
        }

        .project-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary-dark);
            margin: 0 0 8px 0;
        }

        .project-type {
            display: inline-block;
            background: var(--teal);
            color: var(--white);
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .project-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 8px;
        }

        .status-active {
            background: var(--success-light);
            color: var(--success-dark);
        }

        .status-completed {
            background: var(--info-light);
            color: var(--info-dark);
        }

        .status-paused {
            background: var(--warning-light);
            color: var(--warning-dark);
        }

        .project-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .project-description {
            margin: 16px 0;
            color: var(--gray-dark);
            line-height: 1.5;
        }

        .project-meta {
            display: flex;
            gap: 24px;
            margin: 16px 0;
            padding: 12px 0;
            border-top: 1px solid var(--gray-light);
            border-bottom: 1px solid var(--gray-light);
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .meta-label {
            font-size: 12px;
            color: var(--gray);
            font-weight: 500;
        }

        .meta-value {
            font-size: 14px;
            color: var(--primary-dark);
            font-weight: 600;
        }

        /* Project Documents Section */
        .project-documents {
            margin-top: 20px;
            background: var(--gray-light);
            border-radius: 8px;
            padding: 16px;
        }

        .documents-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-dark);
            margin: 0 0 12px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .documents-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .document-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--white);
            padding: 12px;
            border-radius: 6px;
            border: 1px solid var(--gray);
            transition: background-color 0.2s;
        }

        .document-item:hover {
            background: var(--primary-light);
        }

        .document-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .document-icon {
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }

        .document-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .document-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--primary-dark);
        }

        .document-type {
            font-size: 12px;
            color: var(--gray);
            text-transform: capitalize;
        }

        .document-actions {
            display: flex;
            gap: 8px;
        }

        .btn-link {
            background: none;
            border: none;
            color: var(--teal);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-link:hover {
            background: var(--teal-light);
            color: var(--teal-dark);
        }

        .no-documents {
            text-align: center;
            color: var(--gray);
            font-style: italic;
            padding: 20px;
            background: var(--gray-light);
            border-radius: 8px;
            margin-top: 16px;
        }

        .no-data {
            text-align: center;
            color: var(--gray);
            font-style: italic;
            padding: 40px;
            background: var(--gray-light);
            border-radius: 12px;
        }
        /* Position Details Modal Styles */
        .position-details {
            margin: 20px 0;
        }

        .detail-row {
            display: flex;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .detail-row strong {
            min-width: 140px;
            color: var(--primary-dark);
            font-weight: 600;
        }

        .detail-section {
            margin: 16px 0;
        }

        .detail-section strong {
            display: block;
            margin-bottom: 8px;
            color: var(--primary-dark);
            font-weight: 600;
        }

        .detail-content {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .skill-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .skill-tags .tag {
            background: var(--lime);
            color: var(--primary-dark);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #e5e5e7;
        }

    </style>
</head>
<body>
    <div class="app-container">
        <!-- Enhanced Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">🚀</div>
                    <span>RecruitPro ATS</span>
                </div>
            </div>
            
            <nav class="nav-menu">
                <!-- Core Features -->
                <div class="nav-section">
                    <div class="nav-section-title">Core</div>
                    <a href="#dashboard" class="nav-item active" onclick="showPage('dashboard')">
                        <span class="nav-icon">📊</span>
                        <span>Dashboard</span>
                    </a>
                    <a href="#positions" class="nav-item" onclick="showPage('positions')">
                        <span class="nav-icon">💼</span>
                        <span>Positions</span>
                        <span class="nav-badge" id="positionsCount">0</span>
                    </a>
                    <a href="#projects" class="nav-item" onclick="showPage('projects')">
                        <span class="nav-icon">📁</span>
                        <span>Projects</span>
                        <span class="nav-badge" id="projectsCount">0</span>
                    </a>
                    <a href="#candidates" class="nav-item" onclick="showPage('candidates')">
                        <span class="nav-icon">👥</span>
                        <span>Candidates</span>
                        <span class="nav-badge" id="candidatesCount">0</span>
                    </a>
                    <a href="#pipeline" class="nav-item" onclick="showPage('pipeline')">
                        <span class="nav-icon">🎯</span>
                        <span>Pipeline</span>
                    </a>
                </div>

                <!-- AI Features -->
                <div class="nav-section">
                    <div class="nav-section-title">AI Tools</div>
                    <a href="#ai-sourcing" class="nav-item" onclick="showPage('ai-sourcing')">
                        <span class="nav-icon">🤖</span>
                        <span>AI Sourcing</span>
                    </a>
                    <a href="#screening" class="nav-item" onclick="showPage('screening')">
                        <span class="nav-icon">✨</span>
                        <span>AI Screening</span>
                    </a>
                    <a href="#market-research" class="nav-item" onclick="showPage('market-research')">
                        <span class="nav-icon">📈</span>
                        <span>Market Research</span>
                    </a>
                    <a href="#outreach" class="nav-item" onclick="showPage('outreach')">
                        <span class="nav-icon">📧</span>
                        <span>Outreach Copilot</span>
                    </a>
                    <a href="#interviews" class="nav-item" onclick="showPage('interviews')">
                        <span class="nav-icon">🎥</span>
                        <span>Virtual Interviews</span>
                    </a>
                    <a href="#analytics" class="nav-item" onclick="showPage('analytics')">
                        <span class="nav-icon">🔮</span>
                        <span>Predictive Analytics</span>
                    </a>
                </div>

                <!-- Management -->
                <div class="nav-section">
                    <div class="nav-section-title">Management</div>
                    <a href="#documents" class="nav-item" onclick="showPage('documents')">
                        <span class="nav-icon">📄</span>
                        <span>Documents</span>
                    </a>
                    <a href="#reports" class="nav-item" onclick="showPage('reports')">
                        <span class="nav-icon">📊</span>
                        <span>Reports</span>
                    </a>
                    <a href="#settings" class="nav-item" onclick="showPage('settings')">
                        <span class="nav-icon">⚙️</span>
                        <span>Settings</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Top Bar -->
            <header class="topbar">
                <div class="topbar-left">
                    <button class="menu-toggle" onclick="toggleSidebar()">☰</button>
                    <div class="search-bar">
                        <input type="text" class="search-input" placeholder="Search candidates, positions, projects...">
                        <span class="search-icon">🔍</span>
                    </div>
                </div>
                
                <div class="topbar-right">
                    <button class="topbar-btn" onclick="showNotifications()">
                        🔔
                        <span class="notification-badge"></span>
                    </button>
                    <button class="topbar-btn" onclick="showHelp()">❓</button>
                    <div class="user-menu" onclick="showUserMenu()">
                        <div class="user-avatar">AN</div>
                        <div class="user-info">
                            <div class="user-name">Abdulla Nigil</div>
                            <div class="user-role">Talent Acquisition Manager</div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="page-content" id="pageContent">
                <!-- Dashboard Page -->
                <div id="dashboard-page" class="page-section">
                    <div class="page-header">
                        <h1 class="page-title">Dashboard</h1>
                        <p class="page-subtitle">Welcome back! Here's your recruitment overview</p>
                    </div>

                    <!-- Stats Grid -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon blue">📊</div>
                            <div class="stat-content">
                                <div class="stat-label">Active Projects</div>
                                <div class="stat-value">
                                    <span id="activeProjects">12</span>
                                    <span class="stat-change up">+3</span>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon green">💼</div>
                            <div class="stat-content">
                                <div class="stat-label">Open Positions</div>
                                <div class="stat-value">
                                    <span id="openPositions">28</span>
                                    <span class="stat-change up">+5</span>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon orange">👥</div>
                            <div class="stat-content">
                                <div class="stat-label">Total Candidates</div>
                                <div class="stat-value">
                                    <span id="totalCandidates">347</span>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon purple">🎯</div>
                            <div class="stat-content">
                                <div class="stat-label">In Pipeline</div>
                                <div class="stat-value">
                                    <span id="inPipeline">89</span>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon teal">🤖</div>
                            <div class="stat-content">
                                <div class="stat-label">AI Sourcing Jobs</div>
                                <div class="stat-value">
                                    <span id="aiJobs">4</span>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon red">⏱️</div>
                            <div class="stat-content">
                                <div class="stat-label">Avg Time to Fill</div>
                                <div class="stat-value">
                                    <span id="timeToFill">32</span> days
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pipeline Overview -->
                    <div class="pipeline-board">
                        <div class="pipeline-column">
                            <div class="pipeline-header">
                                <span class="pipeline-title">New</span>
                                <span class="pipeline-count">24</span>
                            </div>
                            <div class="pipeline-cards" id="pipeline-new">
                                <div class="candidate-card" draggable="true">
                                    <div class="candidate-name">Sarah Johnson</div>
                                    <div class="candidate-position">Senior Developer</div>
                                    <div class="candidate-tags">
                                        <span class="tag">React</span>
                                        <span class="tag">Node.js</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="pipeline-column">
                            <div class="pipeline-header">
                                <span class="pipeline-title">Screening</span>
                                <span class="pipeline-count">18</span>
                            </div>
                            <div class="pipeline-cards" id="pipeline-screening"></div>
                        </div>

                        <div class="pipeline-column">
                            <div class="pipeline-header">
                                <span class="pipeline-title">Interview</span>
                                <span class="pipeline-count">12</span>
                            </div>
                            <div class="pipeline-cards" id="pipeline-interview"></div>
                        </div>

                        <div class="pipeline-column">
                            <div class="pipeline-header">
                                <span class="pipeline-title">Offer</span>
                                <span class="pipeline-count">5</span>
                            </div>
                            <div class="pipeline-cards" id="pipeline-offer"></div>
                        </div>

                        <div class="pipeline-column">
                            <div class="pipeline-header">
                                <span class="pipeline-title">Hired</span>
                                <span class="pipeline-count">30</span>
                            </div>
                            <div class="pipeline-cards" id="pipeline-hired"></div>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div class="charts-grid">
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3 class="chart-title">Hiring Funnel</h3>
                                <select class="form-select" style="width: auto;">
                                    <option>Last 30 days</option>
                                    <option>Last 90 days</option>
                                    <option>Last year</option>
                                </select>
                            </div>
                            <canvas id="funnelChart"></canvas>
                        </div>

                        <div class="chart-container">
                            <div class="chart-header">
                                <h3 class="chart-title">Source Performance</h3>
                            </div>
                            <canvas id="sourceChart"></canvas>
                        </div>
                    </div>

                    <!-- Activity Feed -->
                    <div class="activity-feed">
                        <h3 class="chart-title">Recent Activity</h3>
                        <div id="activityList">
                            <div class="activity-item">
                                <div class="activity-icon">🤖</div>
                                <div class="activity-content">
                                    <div class="activity-title">AI Sourcing Completed</div>
                                    <div class="activity-description">Found 47 candidates for Senior React Developer</div>
                                    <div class="activity-time">2 minutes ago</div>
                                </div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-icon">✅</div>
                                <div class="activity-content">
                                    <div class="activity-title">Candidate Hired</div>
                                    <div class="activity-description">Michael Chen accepted offer for Product Manager role</div>
                                    <div class="activity-time">1 hour ago</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Other Pages (Hidden by default) -->
                <div id="positions-page" class="page-section" style="display: none;">
                    <div class="page-header">
                        <h1 class="page-title">Position Management</h1>
                        <button class="btn btn-primary" onclick="showCreatePosition()">+ Create Position</button>
                    </div>

                    <div class="data-table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Department</th>
                                    <th>Location</th>
                                    <th>Status</th>
                                    <th>Candidates</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="positionsTable">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- AI Sourcing Page -->
                <div id="ai-sourcing-page" class="page-section" style="display: none;">
                    <div class="page-header">
                        <h1 class="page-title">AI-Powered Sourcing</h1>
                        <p class="page-subtitle">Source candidates from multiple platforms using AI</p>
                    </div>

                    <div class="form-container">
                        <h3>Configure Sourcing Job</h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Select Existing Position (Optional)</label>
                                <select class="form-select" id="existingPosition" onchange="populateFromPosition()">
                                    <option value="">-- Select a position --</option>
                                </select>
                                <div class="form-help">Choose an existing position to auto-populate details, or leave blank for manual entry</div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Position Details</label>
                            <textarea class="form-textarea" id="sourcingDetails" placeholder="Enter job title, required skills, experience level, and any specific requirements..."></textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Platforms to Search</label>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <label><input type="checkbox" id="platform-linkedin" checked> LinkedIn X-Ray</label>
                                    <label><input type="checkbox" id="platform-smartrecruiters"> SmartRecruiters</label>
                                    <label><input type="checkbox" id="platform-github"> GitHub (Coming Soon)</label>
                                    <label><input type="checkbox" id="platform-stackoverflow"> Stack Overflow (Coming Soon)</label>
                                    <label><input type="checkbox" id="platform-indeed"> Indeed (Coming Soon)</label>
                                    <label><input type="checkbox" id="platform-angellist"> AngelList (Coming Soon)</label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Max Candidates</label>
                                <input type="number" class="form-input" value="50" min="10" max="200">
                            </div>
                        </div>

                        <button class="btn btn-primary btn-lg" onclick="startAISourcing()">
                            🤖 Start AI Sourcing
                        </button>

                        <div id="sourcingResults" style="margin-top: 24px;"></div>
                    </div>
                </div>

                <!-- Projects Page -->
                <div id="projects-page" class="page-section" style="display: none;">
                    <!-- Header with Action -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div>
                            <h1 class="page-title">Projects</h1>
                            <p class="page-subtitle">Organize and track your recruitment campaigns</p>
                        </div>
                        <button class="btn btn-primary" onclick="openCreateProjectModal()" style="padding: 12px 24px;">
                            ➕ New Project
                        </button>
                    </div>

                    <!-- Enhanced Stats Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 32px;">
                        <div class="stat-card" style="background: linear-gradient(135deg, var(--teal), var(--dark-teal)); color: white;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <div class="stat-value" id="totalProjects">0</div>
                                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">Total Projects</div>
                                </div>
                                <div class="stat-icon" style="font-size: 32px;">📊</div>
                            </div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, var(--orange), #f57c00); color: white;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <div class="stat-value" id="activeProjects">0</div>
                                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">Active Projects</div>
                                </div>
                                <div class="stat-icon" style="font-size: 32px;">🎯</div>
                            </div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, var(--green), #388e3c); color: white;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <div class="stat-value" id="completedProjects">0</div>
                                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">Completed</div>
                                </div>
                                <div class="stat-icon" style="font-size: 32px;">✅</div>
                            </div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, var(--purple), #7b1fa2); color: white;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <div class="stat-value" id="totalPositions">0</div>
                                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">Total Positions</div>
                                </div>
                                <div class="stat-icon" style="font-size: 32px;">💼</div>
                            </div>
                        </div>
                    </div>

                    <!-- Project Filters and Search -->
                    <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; flex-wrap: wrap; gap: 16px; align-items: center;">
                            <div style="flex: 1; min-width: 250px;">
                                <input type="text" id="projectSearchInput" class="form-input" placeholder="🔍 Search projects..." style="margin: 0;">
                            </div>
                            <div>
                                <select id="projectStatusFilter" class="form-select" style="margin: 0; min-width: 120px;">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="completed">Completed</option>
                                    <option value="on-hold">On Hold</option>
                                </select>
                            </div>
                            <div>
                                <select id="projectTypeFilter" class="form-select" style="margin: 0; min-width: 140px;">
                                    <option value="">All Types</option>
                                    <option value="Mass Hiring">Mass Hiring</option>
                                    <option value="Specialized Role">Specialized Role</option>
                                    <option value="Executive Search">Executive Search</option>
                                    <option value="Internship Program">Internship Program</option>
                                </select>
                            </div>
                            <button class="btn btn-secondary" onclick="clearProjectFilters()">Clear</button>
                        </div>
                    </div>

                    <!-- Projects Grid -->
                    <div id="projectsContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
                        <!-- Projects will be loaded here -->
                    </div>

                    <!-- Empty State -->
                    <div id="projectsEmptyState" style="display: none; text-align: center; padding: 60px 20px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="font-size: 64px; margin-bottom: 16px;">📋</div>
                        <h3 style="color: var(--text-secondary); margin-bottom: 8px;">No Projects Yet</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 24px;">Create your first project to get started with organizing your recruitment campaigns.</p>
                        <button class="btn btn-primary" onclick="openCreateProjectModal()">Create First Project</button>
                    </div>
                </div>

                <!-- Create Project Modal -->
                <div class="modal" id="createProjectModal">
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h2 class="modal-title">Create New Project</h2>
                            <button class="modal-close" onclick="closeModal('createProjectModal')">✕</button>
                        </div>
                        
                        <form id="createProjectForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Project Name *</label>
                                    <input type="text" class="form-input" id="projectName" placeholder="e.g., Q4 Engineering Hiring" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Project Type *</label>
                                    <select class="form-select" id="projectType" required>
                                        <option value="">Select Type</option>
                                        <option value="Mass Hiring">Mass Hiring</option>
                                        <option value="Specialized Role">Specialized Role</option>
                                        <option value="Executive Search">Executive Search</option>
                                        <option value="Internship Program">Internship Program</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Priority</label>
                                    <select class="form-select" id="projectPriority">
                                        <option value="Medium">Medium</option>
                                        <option value="Low">Low</option>
                                        <option value="High">High</option>
                                        <option value="Urgent">Urgent</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="projectStatus">
                                        <option value="active">Active</option>
                                        <option value="planning">Planning</option>
                                        <option value="on-hold">On Hold</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Project Description</label>
                                <textarea class="form-textarea" id="projectDescription" rows="4" placeholder="Describe the project scope, objectives, and key requirements..."></textarea>
                            </div>
                            
                            <!-- Quick Document Upload -->
                            <div class="form-group">
                                <label class="form-label">Initial Documents (Optional)</label>
                                <div style="border: 2px dashed var(--border-color); border-radius: 8px; padding: 24px; text-align: center; background: var(--background-secondary);">
                                    <input type="file" id="projectDocumentFile" accept=".pdf,.doc,.docx,.txt,.xlsx,.pptx" multiple style="display: none;" onchange="handleProjectDocumentUpload(this)">
                                    <div onclick="document.getElementById('projectDocumentFile').click()" style="cursor: pointer;">
                                        <div style="font-size: 32px; margin-bottom: 8px;">📎</div>
                                        <p style="margin: 0; color: var(--text-secondary);">Click to upload documents or drag and drop</p>
                                        <p style="margin: 4px 0 0 0; font-size: 12px; color: var(--text-secondary);">PDF, DOC, DOCX, TXT, XLSX, PPTX (Max 10MB each)</p>
                                    </div>
                                </div>
                                <div id="uploadedDocumentsList" style="margin-top: 12px;"></div>
                            </div>

                            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                                <button type="button" class="btn btn-secondary" onclick="closeModal('createProjectModal')">Cancel</button>
                                <button type="submit" class="btn btn-primary">Create Project</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Candidates Page -->
                <div id="candidates-page" class="page-section" style="display: none;">
                    <div class="page-header">
                        <h1 class="page-title">Candidates</h1>
                        <p class="page-subtitle">Manage your candidate database and pipeline</p>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">👥</div>
                            <div class="stat-value" id="totalCandidates">0</div>
                            <div class="stat-label">Total Candidates</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">🔍</div>
                            <div class="stat-value" id="activeCandidates">0</div>
                            <div class="stat-label">In Pipeline</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">✅</div>
                            <div class="stat-value" id="hiredCandidates">0</div>
                            <div class="stat-label">Hired This Month</div>
                        </div>
                    </div>

                    <div class="form-container">
                        <h3>Search & Filter Candidates</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Search</label>
                                <input type="text" class="form-input" id="candidateSearch" placeholder="Search by name, skills, or position...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status Filter</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="">All Statuses</option>
                                    <option value="new">New</option>
                                    <option value="screening">Screening</option>
                                    <option value="interview">Interview</option>
                                    <option value="offer">Offer</option>
                                    <option value="hired">Hired</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Experience Level</label>
                                <select class="form-select" id="experienceFilter">
                                    <option value="">All Levels</option>
                                    <option value="entry">Entry Level</option>
                                    <option value="mid">Mid Level</option>
                                    <option value="senior">Senior</option>
                                    <option value="executive">Executive</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="searchCandidates()">Search Candidates</button>
                    </div>

                    <div id="candidatesList" style="margin-top: 32px;">
                        <h3>Candidates</h3>
                        <div class="data-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Current Title</th>
                                        <th>Company</th>
                                        <th>Location</th>
                                        <th>Stage</th>
                                        <th>Rating</th>
                                        <th>Source</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Candidates will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Pipeline Page -->
                <div id="pipeline-page" class="page-section" style="display: none;">
                    <div class="page-header">
                        <h1 class="page-title">Candidate Pipeline</h1>
                        <p class="page-subtitle">Track candidates through your recruitment process</p>
                    </div>

                    <div class="pipeline-container">
                        <div class="pipeline-stage">
                            <h3>New Candidates</h3>
                            <div class="stage-count">0</div>
                            <div id="newCandidates" class="candidates-list"></div>
                        </div>
                        <div class="pipeline-stage">
                            <h3>Screening</h3>
                            <div class="stage-count">0</div>
                            <div id="screeningCandidates" class="candidates-list"></div>
                        </div>
                        <div class="pipeline-stage">
                            <h3>Interview</h3>
                            <div class="stage-count">0</div>
                            <div id="interviewCandidates" class="candidates-list"></div>
                        </div>
                        <div class="pipeline-stage">
                            <h3>Final Review</h3>
                            <div class="stage-count">0</div>
                            <div id="finalCandidates" class="candidates-list"></div>
                        </div>
                        <div class="pipeline-stage">
                            <h3>Offer</h3>
                            <div class="stage-count">0</div>
                            <div id="offerCandidates" class="candidates-list"></div>
                        </div>
                    </div>

                    <div style="margin-top: 32px;">
                        <h3>Pipeline Analytics</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon">📈</div>
                                <div class="stat-value" id="conversionRate">0%</div>
                                <div class="stat-label">Conversion Rate</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">⏱️</div>
                                <div class="stat-value" id="avgTimeToHire">0 days</div>
                                <div class="stat-label">Avg Time to Hire</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">🎯</div>
                                <div class="stat-value" id="activePositions">0</div>
                                <div class="stat-label">Active Positions</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Documents Page -->
                <div id="documents-page" class="page-section" style="display: none;">
                    <div class="page-header">
                        <h1 class="page-title">Document Management</h1>
                        <p class="page-subtitle">Upload, organize, and manage recruitment documents</p>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">📄</div>
                            <div class="stat-value" id="totalDocuments">0</div>
                            <div class="stat-label">Total Documents</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">📋</div>
                            <div class="stat-value" id="resumesCount">0</div>
                            <div class="stat-label">Resumes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">📊</div>
                            <div class="stat-value" id="reportsCount">0</div>
                            <div class="stat-label">Reports</div>
                        </div>
                    </div>

                    <div class="form-container">
                        <h3>Upload Document</h3>
                        <div class="form-group">
                            <label class="form-label">Document Type</label>
                            <select class="form-select" id="documentType">
                                <option value="resume">Resume/CV</option>
                                <option value="cover-letter">Cover Letter</option>
                                <option value="job-description">Job Description</option>
                                <option value="interview-notes">Interview Notes</option>
                                <option value="offer-letter">Offer Letter</option>
                                <option value="contract">Contract</option>
                                <option value="report">Report</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Associated Candidate (Optional)</label>
                            <select class="form-select" id="associatedCandidate">
                                <option value="">Select Candidate</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Associated Position (Optional)</label>
                            <select class="form-select" id="associatedPosition">
                                <option value="">Select Position</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Upload File</label>
                            <input type="file" class="form-input" id="documentFile" accept=".pdf,.doc,.docx,.txt">
                            <div class="form-help">Supported formats: PDF, DOC, DOCX, TXT (Max 10MB)</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Document Title</label>
                            <input type="text" class="form-input" id="documentTitle" placeholder="Enter document title">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description (Optional)</label>
                            <textarea class="form-textarea" id="documentDescription" placeholder="Add notes or description..."></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="uploadDocument()">Upload Document</button>
                    </div>

                    <div style="margin-top: 32px;">
                        <h3>Search & Filter Documents</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Search</label>
                                <input type="text" class="form-input" id="documentSearch" placeholder="Search by title, candidate, or type...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Filter by Type</label>
                                <select class="form-select" id="documentTypeFilter">
                                    <option value="">All Types</option>
                                    <option value="resume">Resumes</option>
                                    <option value="cover-letter">Cover Letters</option>
                                    <option value="job-description">Job Descriptions</option>
                                    <option value="interview-notes">Interview Notes</option>
                                    <option value="offer-letter">Offer Letters</option>
                                    <option value="contract">Contracts</option>
                                    <option value="report">Reports</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Date Range</label>
                                <select class="form-select" id="dateFilter">
                                    <option value="">All Time</option>
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                    <option value="quarter">This Quarter</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="searchDocuments()">Search Documents</button>
                    </div>

                    <div id="documentsList" style="margin-top: 32px;">
                        <h3>Documents</h3>
                        <div id="documentsContainer"></div>
                    </div>
                </div>

                <!-- Screening Page -->
                <div id="screening-page" class="page-section" style="display: none;">
                    <div class="page-header">
                        <h1 class="page-title">AI Candidate Screening</h1>
                        <p class="page-subtitle">Automated candidate assessment and scoring</p>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">🎯</div>
                            <div class="stat-value" id="screenedToday">0</div>
                            <div class="stat-label">Screened Today</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">⭐</div>
                            <div class="stat-value" id="avgScore">0</div>
                            <div class="stat-label">Average Score</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">✅</div>
                            <div class="stat-value" id="passedScreening">0</div>
                            <div class="stat-label">Passed Screening</div>
                        </div>
                    </div>

                    <div class="form-container">
                        <h3>Bulk Candidate Screening</h3>
                        <div class="form-group">
                            <label class="form-label">Select Position</label>
                            <select class="form-select" id="screeningPosition">
                                <option value="">Select a position</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Screening Criteria</label>
                            <textarea class="form-textarea" id="screeningCriteria" placeholder="Enter specific requirements, skills, and qualifications to screen for..."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Minimum Score Threshold</label>
                            <input type="range" id="scoreThreshold" min="0" max="100" value="70" class="form-input">
                            <span id="thresholdValue">70</span>%
                        </div>
                        <button class="btn btn-primary" onclick="startBulkScreening()">Start Bulk Screening</button>
                    </div>

                    <div id="screeningResults" style="margin-top: 32px;">
                        <h3>Screening Results</h3>
                        <div id="screeningContainer"></div>
                    </div>
                </div>

                <!-- Market Research Page -->
                <div id="market-research-page" class="page-section" style="display: none;">
                    <div class="page-header">
                        <h1 class="page-title">Market Research & Benchmarking</h1>
                        <p class="page-subtitle">Salary benchmarks, market trends, and competitive analysis</p>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">💰</div>
                            <div class="stat-value" id="avgMarketSalary">$0</div>
                            <div class="stat-label">Market Average</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">📊</div>
                            <div class="stat-value" id="marketTrend">--</div>
                            <div class="stat-label">Salary Trend</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">🏢</div>
                            <div class="stat-value" id="competitorCount">0</div>
                            <div class="stat-label">Competitors Tracked</div>
                        </div>
                    </div>

                    <div class="form-container">
                        <h3>Research Market Data</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Job Title</label>
                                <input type="text" class="form-input" id="researchJobTitle" placeholder="e.g., Senior Software Engineer">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Location</label>
                                <input type="text" class="form-input" id="researchLocation" placeholder="e.g., San Francisco, CA">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Experience Level</label>
                                <select class="form-select" id="researchExperience">
                                    <option>Entry Level (0-2 years)</option>
                                    <option>Mid Level (3-5 years)</option>
                                    <option>Senior Level (6-10 years)</option>
                                    <option>Executive (10+ years)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Industry</label>
                                <select class="form-select" id="researchIndustry">
                                    <option>Technology</option>
                                    <option>Finance</option>
                                    <option>Healthcare</option>
                                    <option>Manufacturing</option>
                                    <option>Retail</option>
                                    <option>Other</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="conductMarketResearch()">Research Market Data</button>
                    </div>

                    <div id="marketResults" style="margin-top: 32px;">
                        <h3>Market Analysis Results</h3>
                        <div id="marketContainer"></div>
                    </div>
                </div>

                <!-- Outreach Page -->
                <div id="outreach-page" class="page-section" style="display: none;">
                    <div class="page-header">
                        <h1 class="page-title">Candidate Outreach</h1>
                        <p class="page-subtitle">Automated email campaigns and follow-up sequences</p>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">📧</div>
                            <div class="stat-value" id="emailsSent">0</div>
                            <div class="stat-label">Emails Sent</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">📈</div>
                            <div class="stat-value" id="openRate">0%</div>
                            <div class="stat-label">Open Rate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">💬</div>
                            <div class="stat-value" id="responseRate">0%</div>
                            <div class="stat-label">Response Rate</div>
                        </div>
                    </div>

                    <div class="form-container">
                        <h3>Create Outreach Campaign</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Campaign Name</label>
                                <input type="text" class="form-input" id="campaignName" placeholder="e.g., Senior Developer Outreach Q4">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Target Position</label>
                                <select class="form-select" id="outreachPosition">
                                    <option value="">Select a position</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Template</label>
                            <select class="form-select" id="emailTemplate">
                                <option>Initial Outreach</option>
                                <option>Follow-up #1</option>
                                <option>Follow-up #2</option>
                                <option>Final Follow-up</option>
                                <option>Custom Template</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Subject</label>
                            <input type="text" class="form-input" id="emailSubject" placeholder="Exciting opportunity at [Company]">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Content</label>
                            <textarea class="form-textarea" id="emailContent" rows="8" placeholder="Hi [Name],

I hope this message finds you well. I came across your profile and was impressed by your experience..."></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Send Schedule</label>
                                <select class="form-select" id="sendSchedule">
                                    <option>Send Now</option>
                                    <option>Schedule for Later</option>
                                    <option>Drip Campaign</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Target Candidates</label>
                                <select class="form-select" id="targetCandidates">
                                    <option>All Candidates</option>
                                    <option>New Candidates</option>
                                    <option>Qualified Candidates</option>
                                    <option>Custom Filter</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="createOutreachCampaign()">Create Campaign</button>
                    </div>

                    <div id="outreachCampaigns" style="margin-top: 32px;">
                        <h3>Active Campaigns</h3>
                        <div id="campaignsContainer"></div>
                    </div>
                </div>

                <!-- Interviews Page -->
                <div id="interviews-page" class="page-section" style="display: none;">
                    <div class="page-header">
                        <h1 class="page-title">Interview Management</h1>
                        <p class="page-subtitle">Schedule, conduct, and track interviews</p>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">📅</div>
                            <div class="stat-value" id="scheduledInterviews">0</div>
                            <div class="stat-label">Scheduled</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">✅</div>
                            <div class="stat-value" id="completedInterviews">0</div>
                            <div class="stat-label">Completed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">⭐</div>
                            <div class="stat-value" id="avgInterviewScore">0</div>
                            <div class="stat-label">Avg Score</div>
                        </div>
                    </div>

                    <div class="form-container">
                        <h3>Schedule New Interview</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Candidate</label>
                                <select class="form-select" id="interviewCandidate">
                                    <option value="">Select candidate</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Position</label>
                                <select class="form-select" id="interviewPosition">
                                    <option value="">Select position</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Interview Type</label>
                                <select class="form-select" id="interviewType">
                                    <option>Phone Screening</option>
                                    <option>Video Interview</option>
                                    <option>Technical Interview</option>
                                    <option>Panel Interview</option>
                                    <option>Final Interview</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Interviewer(s)</label>
                                <input type="text" class="form-input" id="interviewer" placeholder="Enter interviewer names">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Date & Time</label>
                                <input type="datetime-local" class="form-input" id="interviewDateTime">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Duration (minutes)</label>
                                <select class="form-select" id="interviewDuration">
                                    <option>30</option>
                                    <option>45</option>
                                    <option>60</option>
                                    <option>90</option>
                                    <option>120</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Interview Notes</label>
                            <textarea class="form-textarea" id="interviewNotes" placeholder="Add preparation notes, questions to ask, etc."></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="scheduleInterview()">Schedule Interview</button>
                    </div>

                    <div id="interviewCalendar" style="margin-top: 32px;">
                        <h3>Upcoming Interviews</h3>
                        <div id="calendarContainer"></div>
                    </div>
                </div>

                <!-- Analytics Page -->
                <div id="analytics-page" class="page-section" style="display: none;">
                    <div class="page-header">
                        <h1 class="page-title">Recruitment Analytics</h1>
                        <p class="page-subtitle">Advanced metrics, insights, and performance tracking</p>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">📊</div>
                            <div class="stat-value" id="totalMetrics">12</div>
                            <div class="stat-label">Tracked Metrics</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">📈</div>
                            <div class="stat-value" id="improvementTrend">+15%</div>
                            <div class="stat-label">Month over Month</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">🎯</div>
                            <div class="stat-value" id="kpiScore">85</div>
                            <div class="stat-label">KPI Score</div>
                        </div>
                    </div>

                    <div class="form-container">
                        <h3>Analytics Dashboard</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Time Period</label>
                                <select class="form-select" id="analyticsPeriod">
                                    <option>Last 7 days</option>
                                    <option>Last 30 days</option>
                                    <option>Last 90 days</option>
                                    <option>Last 6 months</option>
                                    <option>Last year</option>
                                    <option>Custom range</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Metrics to Display</label>
                                <select class="form-select" id="metricsFilter">
                                    <option>All Metrics</option>
                                    <option>Sourcing Metrics</option>
                                    <option>Screening Metrics</option>
                                    <option>Interview Metrics</option>
                                    <option>Conversion Metrics</option>
                                    <option>Time-to-Hire</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="generateAnalytics()">Generate Report</button>
                    </div>

                    <div id="analyticsCharts" style="margin-top: 32px;">
                        <h3>Key Performance Indicators</h3>
                        <div class="analytics-grid">
                            <div class="analytics-card">
                                <h4>Conversion Funnel</h4>
                                <div id="conversionChart"></div>
                            </div>
                            <div class="analytics-card">
                                <h4>Time to Hire Trend</h4>
                                <div id="timeToHireChart"></div>
                            </div>
                            <div class="analytics-card">
                                <h4>Source Performance</h4>
                                <div id="sourceChart"></div>
                            </div>
                            <div class="analytics-card">
                                <h4>Interview Success Rate</h4>
                                <div id="interviewChart"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Page -->
                <div id="reports-page" class="page-section" style="display: none;">
                    <div class="page-header">
                        <h1 class="page-title">Reports & Exports</h1>
                        <p class="page-subtitle">Generate and download comprehensive recruitment reports</p>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">📋</div>
                            <div class="stat-value" id="totalReports">0</div>
                            <div class="stat-label">Reports Generated</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">⬇️</div>
                            <div class="stat-value" id="reportsDownloaded">0</div>
                            <div class="stat-label">Downloads</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">📅</div>
                            <div class="stat-value" id="lastReportDate">--</div>
                            <div class="stat-label">Last Report</div>
                        </div>
                    </div>

                    <div class="form-container">
                        <h3>Generate Report</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Report Type</label>
                                <select class="form-select" id="reportType">
                                    <option>Candidate Pipeline Report</option>
                                    <option>Hiring Funnel Analysis</option>
                                    <option>Time-to-Hire Report</option>
                                    <option>Source Performance Report</option>
                                    <option>Interview Summary Report</option>
                                    <option>Monthly Recruitment Summary</option>
                                    <option>Custom Report</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Date Range</label>
                                <select class="form-select" id="reportDateRange">
                                    <option>Last 30 days</option>
                                    <option>Last 90 days</option>
                                    <option>Last 6 months</option>
                                    <option>Last year</option>
                                    <option>Year to date</option>
                                    <option>Custom range</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Format</label>
                                <select class="form-select" id="reportFormat">
                                    <option>PDF</option>
                                    <option>Excel (XLSX)</option>
                                    <option>CSV</option>
                                    <option>JSON</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Include Charts</label>
                                <select class="form-select" id="includeCharts">
                                    <option>Yes</option>
                                    <option>No</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Additional Filters</label>
                            <textarea class="form-textarea" id="reportFilters" placeholder="Specify any additional filters (positions, departments, candidates, etc.)"></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="generateReport()">Generate Report</button>
                    </div>

                    <div id="reportHistory" style="margin-top: 32px;">
                        <h3>Report History</h3>
                        <div id="reportsContainer"></div>
                    </div>
                </div>

                <!-- Settings Page -->
                <div id="settings-page" class="page-section" style="display: none;">
                    <div class="page-header">
                        <h1 class="page-title">Settings</h1>
                        <p class="page-subtitle">Configure your RecruitPro settings</p>
                    </div>

                    <div class="form-container">
                        <h3>User Profile</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Full Name</label>
                                <input type="text" class="form-input" id="userFullName" placeholder="Enter your full name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Role/Title</label>
                                <input type="text" class="form-input" id="userRole" placeholder="e.g., Senior Recruiter">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Organization</label>
                                <input type="text" class="form-input" id="userOrganization" placeholder="Your company name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-input" id="userEmail" placeholder="your.email@company.com">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="saveUserProfile()">Update Profile</button>
                    </div>

                    <div class="form-container">
                        <h3>API Configuration</h3>
                        <div style="background: linear-gradient(135deg, #E8F4F8, #F0F8FF); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                            <p style="color: #00617E; margin: 0; font-size: 14px;">
                                🔑 <strong>Configure your API keys for AI-powered features</strong><br>
                                <span style="font-size: 13px; opacity: 0.9;">These keys enable intelligent sourcing, X-ray search automation, and AI candidate evaluation</span>
                            </p>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">🧠 Google AI (Gemini) API Key</label>
                            <input type="password" class="form-input" id="geminiApiKey" placeholder="Enter your Gemini API key">
                            <div class="form-help">Powers AI features • Get from <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">🔍 Google Custom Search API Key</label>
                            <input type="password" class="form-input" id="customSearchApiKey" placeholder="Enter your Custom Search API key">
                            <div class="form-help">Enables automated X-ray search • Get from <a href="https://developers.google.com/custom-search/v1/introduction" target="_blank">Google Cloud Console</a></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">🎯 Custom Search Engine ID</label>
                            <input type="text" class="form-input" id="searchEngineId" placeholder="Enter your Search Engine ID (e.g., 017576662512468239146:omuauf_lfve)">
                            <div class="form-help">Your search engine identifier • Create at <a href="https://cse.google.com/cse/" target="_blank">Programmable Search Engine</a></div>
                        </div>
                        
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="testApiKeys" style="width: auto;">
                                <span>Test API keys after saving</span>
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 12px; margin-top: 16px;">
                            <button class="btn btn-primary" onclick="saveAllApiKeys()">💾 Save All API Keys</button>
                            <button class="btn btn-secondary" onclick="testApiConnections()">🧪 Test Connections</button>
                            <button class="btn btn-outline" onclick="clearApiKeys()">🗑️ Clear Keys</button>
                        </div>
                        
                        <div id="apiConfigStatus" style="margin-top: 16px; display: none;">
                            <!-- Status messages will appear here -->
                        </div>
                    </div>

                    <div class="form-container">
                        <h3>SmartRecruiters Integration</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">SmartRecruiters Email</label>
                                <input type="email" class="form-input" id="smartrecruitersEmail" placeholder="your.email@company.com">
                            </div>
                            <div class="form-group">
                                <label class="form-label">SmartRecruiters Password</label>
                                <input type="password" class="form-input" id="smartrecruitersPassword" placeholder="Enter your password">
                            </div>
                        </div>
                        <div class="form-group">
                            <label><input type="checkbox" id="smartrecruitersHeadless" checked> Run in headless mode (recommended)</label>
                            <div class="form-help">Headless mode runs the browser in the background for better performance</div>
                        </div>
                        <button class="btn btn-primary" onclick="saveSmartRecruitersConfig()">Save SmartRecruiters Config</button>
                    </div>

                    <div class="form-container">
                        <h3>Notification Settings</h3>
                        <div class="form-group">
                            <label><input type="checkbox" id="emailNotifications" checked> Email notifications</label>
                        </div>
                        <div class="form-group">
                            <label><input type="checkbox" id="browserNotifications" checked> Browser notifications</label>
                        </div>
                        <div class="form-group">
                            <label><input type="checkbox" id="dailyReports" checked> Daily reports</label>
                        </div>
                        <button class="btn btn-primary" onclick="saveNotificationSettings()">Save Settings</button>
                    </div>

                    <div class="form-container">
                        <h3>Data Management</h3>
                        <div class="form-group">
                            <button class="btn btn-secondary" onclick="exportData()">Export All Data</button>
                            <button class="btn btn-secondary" onclick="importData()">Import Data</button>
                        </div>
                        <div class="form-group" style="margin-top: 16px;">
                            <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
                            <div class="form-help">⚠️ This will permanently delete all candidates, positions, and projects</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Chatbot Widget -->
    <div class="chatbot-widget">
        <button class="chatbot-button" onclick="toggleChatbot()">💬</button>
        <div class="chatbot-window" id="chatbotWindow">
            <div class="chatbot-header">
                <span>RecruitPro Assistant</span>
                <button onclick="toggleChatbot()" style="background: none; border: none; color: white; cursor: pointer;">✕</button>
            </div>
            <div class="chatbot-messages" id="chatMessages">
                <div class="chat-message bot">
                    <div class="chat-bubble">
                        Hi! I'm your AI recruitment assistant. How can I help you today?
                    </div>
                </div>
            </div>
            <div class="chatbot-input">
                <input type="text" placeholder="Type your message..." id="chatInput" onkeypress="if(event.key=='Enter')sendChatMessage()">
                <button onclick="sendChatMessage()">Send</button>
            </div>
        </div>
    </div>

    <!-- Create Position Modal -->
    <div class="modal" id="createPositionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create New Position</h2>
                <button class="modal-close" onclick="closeModal('createPositionModal')">✕</button>
            </div>
            
            <form id="createPositionForm">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Position Title</label>
                        <input type="text" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Department</label>
                        <select class="form-select">
                            <option>Engineering</option>
                            <option>Product</option>
                            <option>Sales</option>
                            <option>Marketing</option>
                            <option>HR</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Location</label>
                        <input type="text" class="form-input" placeholder="e.g., San Francisco, CA">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Employment Type</label>
                        <select class="form-select">
                            <option>Full-time</option>
                            <option>Part-time</option>
                            <option>Contract</option>
                            <option>Internship</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Job Description</label>
                    <textarea class="form-textarea" placeholder="Enter detailed job description..."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Salary Range</label>
                        <input type="text" class="form-input" placeholder="e.g., $80,000 - $120,000">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Experience Level</label>
                        <select class="form-select">
                            <option>Entry</option>
                            <option>Mid-level</option>
                            <option>Senior</option>
                            <option>Executive</option>
                        </select>
                    </div>
                </div>

                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createPositionModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Position</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Position Modal -->
    <div class="modal" id="editPositionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Position</h2>
                <button class="modal-close" onclick="closeModal('editPositionModal')">✕</button>
            </div>
            
            <form id="editPositionForm">
                <input type="hidden" id="editPositionId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Position Title</label>
                        <input type="text" class="form-input" id="editPositionTitle" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Department</label>
                        <input type="text" class="form-input" id="editPositionDepartment">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Location</label>
                        <input type="text" class="form-input" id="editPositionLocation" placeholder="e.g., San Francisco, CA">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Employment Type</label>
                        <select class="form-select" id="editPositionType">
                            <option value="">Select Type</option>
                            <option value="Full-time">Full-time</option>
                            <option value="Part-time">Part-time</option>
                            <option value="Contract">Contract</option>
                            <option value="Internship">Internship</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Experience Min (years)</label>
                        <input type="number" class="form-input" id="editPositionExpMin" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Experience Max (years)</label>
                        <input type="number" class="form-input" id="editPositionExpMax" min="0">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Salary Min</label>
                        <input type="number" class="form-input" id="editPositionSalaryMin" placeholder="e.g., 80000">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Salary Max</label>
                        <input type="number" class="form-input" id="editPositionSalaryMax" placeholder="e.g., 120000">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="editPositionStatus">
                            <option value="Open">Open</option>
                            <option value="Closed">Closed</option>
                            <option value="On-Hold">On-Hold</option>
                            <option value="Filled">Filled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select class="form-select" id="editPositionPriority">
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                            <option value="Urgent">Urgent</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Number of Openings</label>
                    <input type="number" class="form-input" id="editPositionOpenings" min="1" value="1">
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="editPositionDescription" placeholder="Enter detailed job description..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Requirements</label>
                    <textarea class="form-textarea" id="editPositionRequirements" placeholder="Enter job requirements..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Responsibilities</label>
                    <textarea class="form-textarea" id="editPositionResponsibilities" placeholder="Enter job responsibilities..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Required Skills (comma-separated)</label>
                    <input type="text" class="form-input" id="editPositionSkills" placeholder="e.g., JavaScript, React, Node.js">
                </div>

                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editPositionModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Position</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Candidate Modal -->
    <div class="modal" id="editCandidateModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Candidate</h2>
                <button class="modal-close" onclick="closeModal('editCandidateModal')">✕</button>
            </div>
            
            <form id="editCandidateForm">
                <input type="hidden" id="editCandidateId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">First Name</label>
                        <input type="text" class="form-input" id="editCandidateFirstName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last Name</label>
                        <input type="text" class="form-input" id="editCandidateLastName" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="editCandidateEmail" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-input" id="editCandidatePhone">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Location</label>
                        <input type="text" class="form-input" id="editCandidateLocation" placeholder="e.g., San Francisco, CA">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Current Position</label>
                        <input type="text" class="form-input" id="editCandidateCurrentPosition">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Experience (years)</label>
                        <input type="number" class="form-input" id="editCandidateExperience" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Expected Salary</label>
                        <input type="number" class="form-input" id="editCandidateExpectedSalary">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="editCandidateStatus">
                            <option value="Active">Active</option>
                            <option value="Interviewing">Interviewing</option>
                            <option value="Hired">Hired</option>
                            <option value="Rejected">Rejected</option>
                            <option value="Withdrawn">Withdrawn</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Source</label>
                        <input type="text" class="form-input" id="editCandidateSource" placeholder="e.g., LinkedIn, Indeed">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Skills (comma-separated)</label>
                    <input type="text" class="form-input" id="editCandidateSkills" placeholder="e.g., JavaScript, React, Node.js">
                </div>

                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="editCandidateNotes" placeholder="Additional notes about the candidate..."></textarea>
                </div>

                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editCandidateModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Candidate</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let apiKey = localStorage.getItem('gemini_api_key') || '';
        let currentPage = 'dashboard';
        let chatSessionId = null;

        // Notification system
        function showNotification(message, type = 'info') {
            // Create notification element if it doesn't exist
            let notificationContainer = document.getElementById('notification-container');
            if (!notificationContainer) {
                notificationContainer = document.createElement('div');
                notificationContainer.id = 'notification-container';
                notificationContainer.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 10000;
                    max-width: 400px;
                `;
                document.body.appendChild(notificationContainer);
            }

            // Create notification
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.style.cssText = `
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#2196F3'};
                color: white;
                padding: 12px 20px;
                margin-bottom: 10px;
                border-radius: 4px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                animation: slideInRight 0.3s ease-out;
                cursor: pointer;
            `;
            notification.textContent = message;

            // Add click to dismiss
            notification.onclick = () => notification.remove();

            // Add to container
            notificationContainer.appendChild(notification);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOutRight 0.3s ease-in';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        // Add CSS for animations
        if (!document.getElementById('notification-styles')) {
            const style = document.createElement('style');
            style.id = 'notification-styles';
            style.textContent = `
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOutRight {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
            const isAuthenticated = await checkAuthentication();
            if (isAuthenticated) {
                loadDashboard();
                initializeDragAndDrop();
                setupEventListeners();
            }
        });

        // Authentication - FIXED VERSION
        async function checkAuthentication() {
            console.log('🔐 FIXED: Authentication check is now working (not skipped!)');
            try {
                const response = await fetch('/api/user');
                if (response.ok) {
                    const user = await response.json();
                    console.log('✅ User authenticated:', user.email);
                    return true;
                } else if (response.status === 401 || response.status === 403) {
                    console.log('❌ User not authenticated, redirecting to login...');
                    window.location.href = '/login';
                    return false;
                } else {
                    console.error('❌ Authentication check failed:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('❌ Authentication error:', error);
                return false;
            }
        }

        // Navigation
        function showPage(pageName) {
            // Hide all pages
            document.querySelectorAll('.page-section').forEach(page => {
                page.style.display = 'none';
            });

            // Show selected page
            const pageElement = document.getElementById(pageName + '-page');
            if (pageElement) {
                pageElement.style.display = 'block';
            }

            // Update nav active state
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Only update active state if called from an event
            if (typeof event !== 'undefined' && event.target) {
                const navItem = event.target.closest('.nav-item');
                if (navItem) {
                    navItem.classList.add('active');
                }
            }

            // Load page data
            switch(pageName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'positions':
                    loadPositions();
                    break;
                case 'candidates':
                    loadCandidates();
                    break;
                case 'projects':
                    loadProjects();
                    break;
                case 'ai-sourcing':
                    setupAISourcing();
                    break;
                case 'settings':
                    loadSettings();
                    break;
                // Add more cases as needed
            }

            currentPage = pageName;
        }

        // Sidebar toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
        }

        // Dashboard functions
        async function loadDashboard() {
            try {
                const response = await fetch('/api/dashboard/stats');
                const stats = await response.json();
                
                // Update stats
                document.getElementById('activeProjects').textContent = stats.active_projects;
                document.getElementById('openPositions').textContent = stats.open_positions;
                document.getElementById('totalCandidates').textContent = stats.total_candidates;
                document.getElementById('inPipeline').textContent = stats.in_screening + stats.in_interview;
                document.getElementById('aiJobs').textContent = stats.ai_jobs_running;
                document.getElementById('timeToFill').textContent = stats.time_to_fill;
                
                // Load pipeline
                loadPipeline();
                
                // Load activity
                loadActivity();
                
                // Update sidebar counts
                updateSidebarCounts();
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        async function loadPipeline() {
            try {
                const response = await fetch('/api/candidates?limit=50');
                const data = await response.json();
                
                // Ensure we have a valid array of candidates
                const candidates = Array.isArray(data) ? data : (data.candidates || []);
                
                // Group by stage
                const stages = {
                    'new': [],
                    'screening': [],
                    'interview': [],
                    'offer': [],
                    'hired': []
                };
                
                candidates.forEach(candidate => {
                    const stage = candidate.stage?.toLowerCase() || 'new';
                    if (stage.includes('interview')) {
                        stages.interview.push(candidate);
                    } else if (stages[stage]) {
                        stages[stage].push(candidate);
                    }
                });
                
                // Render pipeline cards
                Object.keys(stages).forEach(stage => {
                    const container = document.getElementById(`pipeline-${stage}`);
                    if (container) {
                        container.innerHTML = stages[stage].map(candidate => `
                            <div class="candidate-card" draggable="true" data-id="${candidate.id}">
                                <div class="candidate-name">${candidate.name}</div>
                                <div class="candidate-position">${candidate.position_title || 'Position'}</div>
                                <div class="candidate-tags">
                                    ${(candidate.skills || []).slice(0, 2).map(skill => 
                                        `<span class="tag">${skill}</span>`
                                    ).join('')}
                                </div>
                            </div>
                        `).join('');
                    }
                });
                
            } catch (error) {
                console.error('Error loading pipeline:', error);
            }
        }

        async function loadActivity() {
            try {
                const response = await fetch('/api/activity?limit=10');
                const activities = await response.json();
                
                const activityList = document.getElementById('activityList');
                activityList.innerHTML = activities.map(activity => {
                    const icon = getActivityIcon(activity.type);
                    const time = getRelativeTime(activity.timestamp);
                    
                    return `
                        <div class="activity-item">
                            <div class="activity-icon">${icon}</div>
                            <div class="activity-content">
                                <div class="activity-title">${activity.type.replace('_', ' ').toUpperCase()}</div>
                                <div class="activity-description">${activity.details}</div>
                                <div class="activity-time">${time}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading activity:', error);
            }
        }

        // Positions management
        async function loadPositions() {
            try {
                const response = await fetch('/api/positions');
                const positions = await response.json();
                
                const tbody = document.getElementById('positionsTable');
                tbody.innerHTML = positions.map(position => `
                    <tr>
                        <td>${position.title}</td>
                        <td>${position.department}</td>
                        <td>${position.location}</td>
                        <td><span class="tag">${position.status}</span></td>
                        <td>${position.candidate_count || 0}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="viewPosition('${position.id}')">View</button>
                            <button class="btn btn-sm btn-secondary" onclick="editPosition('${position.id}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deletePosition('${position.id}', '${position.title}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
                
                // Update sidebar counts
                updateSidebarCounts();
                
            } catch (error) {
                console.error('Error loading positions:', error);
            }
        }

        async function loadCandidates() {
            try {
                const response = await fetch('/api/candidates?limit=100');
                const candidates = await response.json();
                
                const candidatesTableBody = document.querySelector('#candidates-page tbody');
                if (!candidatesTableBody) {
                    console.error('Candidates table body not found');
                    return;
                }
                
                candidatesTableBody.innerHTML = candidates.map(candidate => `
                    <tr>
                        <td>${candidate.name}</td>
                        <td>${candidate.email || 'N/A'}</td>
                        <td>${candidate.current_title || 'N/A'}</td>
                        <td>${candidate.current_company || 'N/A'}</td>
                        <td>${candidate.location || 'N/A'}</td>
                        <td><span class="tag">${candidate.pipeline_stage || 'New'}</span></td>
                        <td><span class="rating">${candidate.rating || 'N/A'}</span></td>
                        <td>${candidate.source || 'Direct'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="viewCandidate('${candidate.id}')">View</button>
                            <button class="btn btn-sm btn-secondary" onclick="editCandidate('${candidate.id}')">Edit</button>
                        </td>
                    </tr>
                `).join('');
                
                // Update sidebar count
                updateSidebarCounts();
                
            } catch (error) {
                console.error('Error loading candidates:', error);
            }
        }

        async function updateSidebarCounts() {
            try {
                // Get counts from API
                const [positionsRes, candidatesRes, projectsRes] = await Promise.all([
                    fetch('/api/positions'),
                    fetch('/api/candidates'),
                    fetch('/api/projects')
                ]);
                
                const positions = await positionsRes.json();
                const candidates = await candidatesRes.json();
                const projects = await projectsRes.json();
                
                // Update sidebar badges
                document.getElementById('positionsCount').textContent = positions.length;
                document.getElementById('candidatesCount').textContent = candidates.length;
                document.getElementById('projectsCount').textContent = projects.length;
                
            } catch (error) {
                console.error('Error updating sidebar counts:', error);
            }
        }

        function showCreatePosition() {
            document.getElementById('createPositionModal').classList.add('active');
        }

        async function viewPosition(positionId) {
            try {
                const response = await fetch(`/api/positions/${positionId}`);
                const position = await response.json();
                
                // Create position details modal
                const modalContent = `
                    <div class="modal active" id="viewPositionModal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2>Position Details</h2>
                                <button class="modal-close" onclick="closeModal('viewPositionModal')">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="position-details">
                                    <div class="detail-row">
                                        <strong>Title:</strong> ${position.title}
                                    </div>
                                    <div class="detail-row">
                                        <strong>Department:</strong> ${position.department || 'Not specified'}
                                    </div>
                                    <div class="detail-row">
                                        <strong>Location:</strong> ${position.location || 'Not specified'}
                                    </div>
                                    <div class="detail-row">
                                        <strong>Employment Type:</strong> ${position.employment_type || 'Not specified'}
                                    </div>
                                    <div class="detail-row">
                                        <strong>Experience:</strong> ${position.experience_min || 0}-${position.experience_max || 'N/A'} years
                                    </div>
                                    <div class="detail-row">
                                        <strong>Salary Range:</strong> ${position.salary_min ? '$' + position.salary_min.toLocaleString() : 'N/A'} - ${position.salary_max ? '$' + position.salary_max.toLocaleString() : 'N/A'}
                                    </div>
                                    <div class="detail-row">
                                        <strong>Status:</strong> <span class="tag">${position.status}</span>
                                    </div>
                                    <div class="detail-row">
                                        <strong>Priority:</strong> ${position.priority}
                                    </div>
                                    <div class="detail-row">
                                        <strong>Openings:</strong> ${position.openings || 1}
                                    </div>
                                    ${position.description ? `
                                    <div class="detail-section">
                                        <strong>Description:</strong>
                                        <div class="detail-content">${position.description}</div>
                                    </div>
                                    ` : ''}
                                    ${position.requirements ? `
                                    <div class="detail-section">
                                        <strong>Requirements:</strong>
                                        <div class="detail-content">${position.requirements}</div>
                                    </div>
                                    ` : ''}
                                    ${position.responsibilities ? `
                                    <div class="detail-section">
                                        <strong>Responsibilities:</strong>
                                        <div class="detail-content">${position.responsibilities}</div>
                                    </div>
                                    ` : ''}
                                    ${position.skills_required && position.skills_required.length ? `
                                    <div class="detail-section">
                                        <strong>Required Skills:</strong>
                                        <div class="skill-tags">
                                            ${position.skills_required.map(skill => `<span class="tag">${skill}</span>`).join('')}
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                                <div class="modal-actions">
                                    <button class="btn btn-secondary" onclick="editPosition('${position.id}')">Edit Position</button>
                                    <button class="btn btn-primary" onclick="closeModal('viewPositionModal')">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if any
                const existingModal = document.getElementById('viewPositionModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Add modal to body
                document.body.insertAdjacentHTML('beforeend', modalContent);
                
            } catch (error) {
                console.error('Error loading position details:', error);
                showNotification('Failed to load position details', 'error');
            }
        }

        async function editPosition(positionId) {
            try {
                const response = await fetch(`/api/positions/${positionId}`);
                const position = await response.json();
                
                // Populate edit form
                document.getElementById('editPositionId').value = position.id;
                document.getElementById('editPositionTitle').value = position.title;
                document.getElementById('editPositionDepartment').value = position.department || '';
                document.getElementById('editPositionLocation').value = position.location || '';
                document.getElementById('editPositionType').value = position.employment_type || '';
                document.getElementById('editPositionExpMin').value = position.experience_min || '';
                document.getElementById('editPositionExpMax').value = position.experience_max || '';
                document.getElementById('editPositionSalaryMin').value = position.salary_min || '';
                document.getElementById('editPositionSalaryMax').value = position.salary_max || '';
                document.getElementById('editPositionStatus').value = position.status || 'Open';
                document.getElementById('editPositionPriority').value = position.priority || 'Medium';
                document.getElementById('editPositionOpenings').value = position.openings || 1;
                document.getElementById('editPositionDescription').value = position.description || '';
                document.getElementById('editPositionRequirements').value = position.requirements || '';
                document.getElementById('editPositionResponsibilities').value = position.responsibilities || '';
                document.getElementById('editPositionSkills').value = Array.isArray(position.skills_required) ? position.skills_required.join(', ') : '';
                
                // Show edit modal
                document.getElementById('editPositionModal').classList.add('active');
                
            } catch (error) {
                console.error('Error loading position for edit:', error);
                showNotification('Failed to load position for editing', 'error');
            }
        }

        async function deletePosition(positionId, positionTitle) {
            if (!confirm(`Are you sure you want to delete the position "${positionTitle}"? This action cannot be undone and will affect all associated candidates.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/positions/${positionId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showNotification('Position deleted successfully', 'success');
                    loadPositions(); // Reload the positions list
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to delete position', 'error');
                }
            } catch (error) {
                console.error('Error deleting position:', error);
                showNotification('Failed to delete position', 'error');
            }
        }

        async function viewCandidate(candidateId) {
            try {
                const response = await fetch(`/api/candidates/${candidateId}`);
                const candidate = await response.json();
                
                // Create candidate details modal
                const modalContent = `
                    <div class="modal active" id="viewCandidateModal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2>Candidate Details</h2>
                                <button class="modal-close" onclick="closeModal('viewCandidateModal')">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="candidate-details">
                                    <div class="detail-row">
                                        <strong>Name:</strong> ${candidate.name}
                                    </div>
                                    <div class="detail-row">
                                        <strong>Email:</strong> ${candidate.email || 'Not provided'}
                                    </div>
                                    <div class="detail-row">
                                        <strong>Phone:</strong> ${candidate.phone || 'Not provided'}
                                    </div>
                                    <div class="detail-row">
                                        <strong>Current Title:</strong> ${candidate.current_title || 'Not specified'}
                                    </div>
                                    <div class="detail-row">
                                        <strong>Current Company:</strong> ${candidate.current_company || 'Not specified'}
                                    </div>
                                    <div class="detail-row">
                                        <strong>Location:</strong> ${candidate.location || 'Not specified'}
                                    </div>
                                    <div class="detail-row">
                                        <strong>Experience:</strong> ${candidate.years_experience || 'N/A'} years
                                    </div>
                                    <div class="detail-row">
                                        <strong>Pipeline Stage:</strong> <span class="tag">${candidate.pipeline_stage || 'New'}</span>
                                    </div>
                                    <div class="detail-row">
                                        <strong>Status:</strong> <span class="tag">${candidate.status || 'Active'}</span>
                                    </div>
                                    <div class="detail-row">
                                        <strong>Rating:</strong> ${candidate.rating || 'Not rated'}
                                    </div>
                                    <div class="detail-row">
                                        <strong>Source:</strong> ${candidate.source || 'Direct'}
                                    </div>
                                    ${candidate.linkedin_url ? `
                                    <div class="detail-row">
                                        <strong>LinkedIn:</strong> <a href="${candidate.linkedin_url}" target="_blank">View Profile</a>
                                    </div>
                                    ` : ''}
                                    ${candidate.skills && candidate.skills.length ? `
                                    <div class="detail-section">
                                        <strong>Skills:</strong>
                                        <div class="skill-tags">
                                            ${candidate.skills.map(skill => `<span class="tag">${skill}</span>`).join('')}
                                        </div>
                                    </div>
                                    ` : ''}
                                    ${candidate.notes ? `
                                    <div class="detail-section">
                                        <strong>Notes:</strong>
                                        <div class="detail-content">${candidate.notes}</div>
                                    </div>
                                    ` : ''}
                                </div>
                                <div class="modal-actions">
                                    <button class="btn btn-secondary" onclick="editCandidate('${candidate.id}')">Edit Candidate</button>
                                    <button class="btn btn-primary" onclick="closeModal('viewCandidateModal')">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if any
                const existingModal = document.getElementById('viewCandidateModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Add modal to body
                document.body.insertAdjacentHTML('beforeend', modalContent);
                
            } catch (error) {
                console.error('Error loading candidate details:', error);
                showNotification('Failed to load candidate details', 'error');
            }
        }

        async function editCandidate(candidateId) {
            try {
                const response = await fetch(`/api/candidates/${candidateId}`);
                const candidate = await response.json();
                
                // Populate edit form
                document.getElementById('editCandidateId').value = candidate.id;
                document.getElementById('editCandidateName').value = candidate.name;
                document.getElementById('editCandidateEmail').value = candidate.email || '';
                document.getElementById('editCandidatePhone').value = candidate.phone || '';
                document.getElementById('editCandidateTitle').value = candidate.current_title || '';
                document.getElementById('editCandidateCompany').value = candidate.current_company || '';
                document.getElementById('editCandidateLocation').value = candidate.location || '';
                document.getElementById('editCandidateExperience').value = candidate.years_experience || '';
                document.getElementById('editCandidateStage').value = candidate.pipeline_stage || 'New';
                document.getElementById('editCandidateStatus').value = candidate.status || 'Active';
                document.getElementById('editCandidateRating').value = candidate.rating || '';
                document.getElementById('editCandidateSource').value = candidate.source || '';
                document.getElementById('editCandidateLinkedIn').value = candidate.linkedin_url || '';
                document.getElementById('editCandidateSkills').value = Array.isArray(candidate.skills) ? candidate.skills.join(', ') : '';
                document.getElementById('editCandidateNotes').value = candidate.notes || '';
                
                // Show edit modal
                document.getElementById('editCandidateModal').classList.add('active');
                
            } catch (error) {
                console.error('Error loading candidate for edit:', error);
                showNotification('Failed to load candidate for editing', 'error');
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // User Profile Functions
        // User menu functions
        function showUserMenu() {
            const userMenu = document.querySelector('.user-menu-dropdown');
            if (userMenu) {
                userMenu.classList.toggle('show');
            } else {
                // Create user menu dropdown if it doesn't exist
                const userMenuContainer = document.querySelector('.user-menu');
                if (userMenuContainer) {
                    const dropdown = document.createElement('div');
                    dropdown.className = 'user-menu-dropdown';
                    dropdown.style.cssText = `
                        position: absolute;
                        top: 100%;
                        right: 0;
                        background: white;
                        border: 1px solid #ddd;
                        border-radius: 4px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        min-width: 200px;
                        z-index: 1000;
                        display: none;
                    `;
                    dropdown.innerHTML = `
                        <div style="padding: 8px 0;">
                            <div style="padding: 8px 16px; border-bottom: 1px solid #eee;">
                                <strong>Welcome!</strong>
                            </div>
                            <a href="#" onclick="showPage('settings')" style="display: block; padding: 8px 16px; text-decoration: none; color: #333;">
                                Settings
                            </a>
                            <a href="/logout" style="display: block; padding: 8px 16px; text-decoration: none; color: #333;">
                                Logout
                            </a>
                        </div>
                    `;
                    userMenuContainer.style.position = 'relative';
                    userMenuContainer.appendChild(dropdown);
                    dropdown.style.display = 'block';
                    
                    // Close menu when clicking outside
                    document.addEventListener('click', function(e) {
                        if (!userMenuContainer.contains(e.target)) {
                            dropdown.style.display = 'none';
                        }
                    });
                }
            }
        }

        async function loadUserProfile() {
            try {
                const response = await fetch('/api/user/profile');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.user) {
                        document.getElementById('userFullName').value = data.user.name || '';
                        document.getElementById('userRole').value = data.user.role || '';
                        document.getElementById('userOrganization').value = data.user.organization || '';
                        document.getElementById('userEmail').value = data.user.email || '';
                    }
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        }

        async function saveUserProfile() {
            const profileData = {
                name: document.getElementById('userFullName').value.trim(),
                role: document.getElementById('userRole').value.trim(),
                organization: document.getElementById('userOrganization').value.trim(),
                email: document.getElementById('userEmail').value.trim()
            };

            if (!profileData.name) {
                showNotification('Please enter your full name', 'error');
                return;
            }

            try {
                const response = await fetch('/api/user/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(profileData)
                });

                if (response.ok) {
                    showNotification('Profile updated successfully!', 'success');
                    // Update the dropdown display
                    const displayName = document.getElementById('userDisplayName');
                    const displayRole = document.getElementById('userDisplayRole');
                    if (displayName) displayName.textContent = profileData.name;
                    if (displayRole) displayRole.textContent = profileData.role || 'Recruiter';
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to update profile', 'error');
                }
            } catch (error) {
                console.error('Error saving user profile:', error);
                showNotification('Failed to update profile', 'error');
            }
        }

        // Settings Functions
        async function saveAllApiKeys() {
            const geminiKey = document.getElementById('geminiApiKey').value.trim();
            const customSearchKey = document.getElementById('customSearchApiKey').value.trim();
            const searchEngineId = document.getElementById('searchEngineId').value.trim();
            const testAfterSave = document.getElementById('testApiKeys').checked;
            
            const statusDiv = document.getElementById('apiConfigStatus');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<div style="color: #00617E;">💾 Saving API keys...</div>';
            
            try {
                // Send to backend to save in database
                const response = await fetch('/api/settings/api-keys', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        gemini_api_key: geminiKey,
                        custom_search_api_key: customSearchKey,
                        search_engine_id: searchEngineId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Also save to localStorage for quick access
                    if (geminiKey) localStorage.setItem('gemini_api_key', geminiKey);
                    if (customSearchKey) localStorage.setItem('custom_search_api_key', customSearchKey);
                    if (searchEngineId) localStorage.setItem('search_engine_id', searchEngineId);
                    
                    statusDiv.innerHTML = '<div style="color: #00A78B;">✅ API keys saved successfully!</div>';
                    showNotification('API keys saved successfully!', 'success');
                    
                    // Clear inputs for security
                    document.getElementById('geminiApiKey').value = '';
                    document.getElementById('customSearchApiKey').value = '';
                    
                    if (testAfterSave) {
                        setTimeout(() => testApiConnections(), 1000);
                    }
                } else {
                    statusDiv.innerHTML = `<div style="color: #C8313F;">❌ Error: ${result.error}</div>`;
                    showNotification(result.error || 'Failed to save API keys', 'error');
                }
            } catch (error) {
                console.error('Error saving API keys:', error);
                statusDiv.innerHTML = '<div style="color: #C8313F;">❌ Failed to save API keys</div>';
                showNotification('Error saving API keys. Please try again.', 'error');
            }
        }
        
        async function testApiConnections() {
            const statusDiv = document.getElementById('apiConfigStatus');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<div style="color: #00617E;">🧪 Testing API connections...</div>';
            
            try {
                const response = await fetch('/api/settings/test-api-keys', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    let statusHTML = '<div style="margin-top: 12px;">';
                    
                    // Gemini API Status
                    statusHTML += `<div style="padding: 8px; background: ${result.gemini ? '#E5F9F7' : '#FFE5E8'}; border-radius: 4px; margin-bottom: 8px;">`;
                    statusHTML += `${result.gemini ? '✅' : '❌'} Gemini AI: ${result.gemini ? 'Connected' : 'Not configured or invalid'}`;
                    if (result.gemini_message) statusHTML += `<br><span style="font-size: 12px;">${result.gemini_message}</span>`;
                    statusHTML += '</div>';
                    
                    // Custom Search API Status  
                    statusHTML += `<div style="padding: 8px; background: ${result.custom_search ? '#E5F9F7' : '#FFE5E8'}; border-radius: 4px; margin-bottom: 8px;">`;
                    statusHTML += `${result.custom_search ? '✅' : '❌'} Google Search: ${result.custom_search ? 'Connected' : 'Not configured or invalid'}`;
                    if (result.search_message) statusHTML += `<br><span style="font-size: 12px;">${result.search_message}</span>`;
                    statusHTML += '</div>';
                    
                    statusHTML += '</div>';
                    statusDiv.innerHTML = statusHTML;
                    
                    if (result.gemini && result.custom_search) {
                        showNotification('All API connections successful! 🎉', 'success');
                    } else if (result.gemini || result.custom_search) {
                        showNotification('Some API connections successful', 'info');
                    } else {
                        showNotification('No valid API keys configured', 'warning');
                    }
                } else {
                    statusDiv.innerHTML = `<div style="color: #C8313F;">❌ Test failed: ${result.error}</div>`;
                    showNotification('Failed to test API connections', 'error');
                }
            } catch (error) {
                console.error('Error testing API connections:', error);
                statusDiv.innerHTML = '<div style="color: #C8313F;">❌ Failed to test connections</div>';
                showNotification('Error testing API connections', 'error');
            }
        }
        
        function clearApiKeys() {
            if (!confirm('Are you sure you want to clear all API keys? This will disable AI features.')) {
                return;
            }
            
            // Clear from localStorage
            localStorage.removeItem('gemini_api_key');
            localStorage.removeItem('custom_search_api_key');
            localStorage.removeItem('search_engine_id');
            
            // Clear input fields
            document.getElementById('geminiApiKey').value = '';
            document.getElementById('customSearchApiKey').value = '';
            document.getElementById('searchEngineId').value = '';
            
            // Clear backend storage
            fetch('/api/settings/api-keys', {
                method: 'DELETE'
            }).then(() => {
                showNotification('API keys cleared', 'info');
                const statusDiv = document.getElementById('apiConfigStatus');
                statusDiv.style.display = 'block';
                statusDiv.innerHTML = '<div style="color: #5D858B;">🗑️ API keys have been cleared</div>';
            });
        }
        
        // Legacy single key save function for backward compatibility
        function saveApiKey() {
            const apiKeyInput = document.getElementById('geminiApiKey');
            const newApiKey = apiKeyInput.value.trim();
            
            if (!newApiKey) {
                alert('Please enter an API key');
                return;
            }
            
            // Save using the new function
            saveAllApiKeys();
        }

        async function saveSmartRecruitersConfig() {
            const email = document.getElementById('smartrecruitersEmail').value.trim();
            const password = document.getElementById('smartrecruitersPassword').value.trim();
            const headless = document.getElementById('smartrecruitersHeadless').checked;
            
            if (!email || !password) {
                showNotification('Please enter both email and password for SmartRecruiters', 'error');
                return;
            }
            
            try {
                // Get current API key
                const apiKey = localStorage.getItem('gemini_api_key');
                if (!apiKey) {
                    showNotification('Please configure AI API key first', 'error');
                    return;
                }
                
                const response = await fetch('/api/ai/configure', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        api_key: apiKey,
                        smartrecruiters_email: email,
                        smartrecruiters_password: password,
                        smartrecruiters_headless: headless
                    })
                });
                
                if (response.ok) {
                    showNotification('SmartRecruiters configuration saved successfully!', 'success');
                    
                    // Clear password field for security
                    document.getElementById('smartrecruitersPassword').value = '';
                    
                    // Save email to localStorage for convenience (not password)
                    localStorage.setItem('smartrecruiters_email', email);
                    localStorage.setItem('smartrecruiters_headless', headless);
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to save SmartRecruiters configuration', 'error');
                }
            } catch (error) {
                console.error('Error saving SmartRecruiters config:', error);
                showNotification('Failed to save SmartRecruiters configuration', 'error');
            }
        }

        function loadSettings() {
            // Load user profile
            loadUserProfile();
            
            // Load saved API key (but don't display it for security)
            const savedApiKey = localStorage.getItem('gemini_api_key');
            if (savedApiKey) {
                // Just show a placeholder to indicate it's set
                document.getElementById('geminiApiKey').placeholder = 'API key is set (hidden for security)';
            }
            
            // Load saved SmartRecruiters settings
            const savedEmail = localStorage.getItem('smartrecruiters_email');
            const savedHeadless = localStorage.getItem('smartrecruiters_headless');
            
            if (savedEmail) {
                document.getElementById('smartrecruitersEmail').value = savedEmail;
            }
            if (savedHeadless !== null) {
                document.getElementById('smartrecruitersHeadless').checked = savedHeadless === 'true';
            }
        }

        // Save notification settings
        function saveNotificationSettings() {
            try {
                const settings = {
                    email_notifications: document.getElementById('emailNotifications')?.checked || false,
                    system_updates: document.getElementById('systemUpdates')?.checked || false,
                    candidate_updates: document.getElementById('candidateUpdates')?.checked || false,
                    interview_reminders: document.getElementById('interviewReminders')?.checked || false,
                    daily_reports: document.getElementById('dailyReports')?.checked || false
                };

                // Save to localStorage for now (in production, this would be saved via API)
                localStorage.setItem('notification_settings', JSON.stringify(settings));
                
                showNotification('Notification settings saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving notification settings:', error);
                showNotification('Failed to save notification settings', 'error');
            }
        }

        // Load notification settings
        function loadNotificationSettings() {
            try {
                const settings = JSON.parse(localStorage.getItem('notification_settings') || '{}');
                
                if (document.getElementById('emailNotifications')) {
                    document.getElementById('emailNotifications').checked = settings.email_notifications || false;
                }
                if (document.getElementById('systemUpdates')) {
                    document.getElementById('systemUpdates').checked = settings.system_updates || false;
                }
                if (document.getElementById('candidateUpdates')) {
                    document.getElementById('candidateUpdates').checked = settings.candidate_updates || false;
                }
                if (document.getElementById('interviewReminders')) {
                    document.getElementById('interviewReminders').checked = settings.interview_reminders || false;
                }
                if (document.getElementById('dailyReports')) {
                    document.getElementById('dailyReports').checked = settings.daily_reports || false;
                }
            } catch (error) {
                console.error('Error loading notification settings:', error);
            }
        }

        // AI Sourcing
        async function setupAISourcing() {
            // Initialize sourcing page
            await loadPositionsForSourcing();
            
            // Check API key (but don't show alert if missing)
            if (!apiKey) {
                console.log('API key not set - will show warning when starting sourcing');
            }
        }
        
        async function loadPositionsForSourcing() {
            try {
                const response = await fetch('/api/positions');
                if (response.ok) {
                    const positions = await response.json();
                    const select = document.getElementById('existingPosition');
                    
                    // Clear existing options except the first one
                    select.innerHTML = '<option value="">-- Select a position --</option>';
                    
                    // Add positions to dropdown
                    positions.forEach(position => {
                        const option = document.createElement('option');
                        option.value = position.id;
                        option.textContent = position.title;
                        option.dataset.position = JSON.stringify(position);
                        select.appendChild(option);
                    });
                } else {
                    console.error('Failed to load positions');
                }
            } catch (error) {
                console.error('Error loading positions:', error);
            }
        }
        
        function populateFromPosition() {
            const select = document.getElementById('existingPosition');
            const selectedOption = select.selectedOptions[0];
            
            if (selectedOption && selectedOption.dataset.position) {
                const position = JSON.parse(selectedOption.dataset.position);
                
                // Populate the position details textarea
                const details = `Job Title: ${position.title}
Department: ${position.department || 'Not specified'}
Location: ${position.location || 'Not specified'}
Experience Level: ${position.experience_level || 'Not specified'}

Job Description:
${position.description || 'No description available'}

Required Skills:
${position.required_skills ? position.required_skills.join(', ') : 'None specified'}

Preferred Skills:
${position.preferred_skills ? position.preferred_skills.join(', ') : 'None specified'}

Additional Requirements:
${position.additional_requirements || 'None specified'}`;
                
                document.getElementById('sourcingDetails').value = details;
            } else {
                // Clear the textarea if no position is selected
                document.getElementById('sourcingDetails').value = '';
            }
        }

        async function startAISourcing() {
            const details = document.getElementById('sourcingDetails').value;
            const positionSelect = document.getElementById('existingPosition');
            
            if (!details && !positionSelect.value) {
                showNotification('Please enter position details or select an existing position', 'error');
                return;
            }
            
            // Check platform selection
            const linkedinChecked = document.getElementById('platform-linkedin').checked;
            const smartrecruitersChecked = document.getElementById('platform-smartrecruiters').checked;
            const githubChecked = document.getElementById('platform-github').checked;
            
            if (!linkedinChecked && !smartrecruitersChecked && !githubChecked) {
                showNotification('Please select at least one platform to search', 'error');
                return;
            }
            
            // Build platforms array for supported platforms
            const selectedPlatforms = [];
            if (linkedinChecked) selectedPlatforms.push('linkedin');
            if (smartrecruitersChecked) selectedPlatforms.push('smartrecruiters');
            
            // Show info about platform support
            const unsupportedPlatforms = [];
            if (githubChecked) unsupportedPlatforms.push('GitHub');
            if (document.getElementById('platform-stackoverflow').checked) unsupportedPlatforms.push('Stack Overflow');
            if (document.getElementById('platform-indeed').checked) unsupportedPlatforms.push('Indeed');
            if (document.getElementById('platform-angellist').checked) unsupportedPlatforms.push('AngelList');
            
            if (unsupportedPlatforms.length > 0) {
                showNotification(`Note: ${unsupportedPlatforms.join(', ')} keyword generation available via Gemini AI.`, 'info');
            }
            
            const resultsDiv = document.getElementById('sourcingResults');
            resultsDiv.innerHTML = `
                <div style="background: linear-gradient(135deg, var(--teal), var(--dark-teal)); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                    <div class="spinner" style="margin: 0 auto 16px;"></div>
                    <h3>🧠 Gemini AI Sourcing in Progress...</h3>
                    <p>Using Gemini 2.0 Flash to generate intelligent search strategies</p>
                    <div id="sourcingProgress" style="margin-top: 16px; color: rgba(255,255,255,0.9);"></div>
                </div>
            `;
            
            // Start with Gemini AI-powered intelligent sourcing workflow
            await executeGeminiSourcing(positionSelect.value, details, selectedPlatforms);
            
            try {
                // Get max candidates from input
                const maxCandidatesInput = document.querySelector('input[type="number"]');
                const maxCandidates = maxCandidatesInput ? parseInt(maxCandidatesInput.value) || 10 : 10;
                
                // Prepare request data
                const requestData = {
                    max_candidates: maxCandidates,
                    platforms: selectedPlatforms
                };
                
                // If a position is selected, use the position_id
                if (positionSelect.value) {
                    requestData.position_id = positionSelect.value;
                } else {
                    // If using manual details, parse them into requirements
                    requestData.requirements = {
                        description: details,
                        title: 'Manual Search'
                    };
                }
                
                const response = await fetch('/api/ai/sourcing/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`Successfully sourced ${result.candidates_saved} new candidates!`, 'success');
                    
                    const campaignStats = result.campaign_stats || {};
                    resultsDiv.innerHTML = `
                        <div style="background: linear-gradient(135deg, var(--teal), var(--dark-teal)); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <h3>🎉 AI Sourcing Complete!</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-top: 16px;">
                                <div>
                                    <div style="font-size: 24px; font-weight: bold;">${result.candidates_found}</div>
                                    <div style="opacity: 0.9;">Total Found</div>
                                </div>
                                <div>
                                    <div style="font-size: 24px; font-weight: bold;">${result.candidates_saved}</div>
                                    <div style="opacity: 0.9;">New Added</div>
                                </div>
                                <div>
                                    <div style="font-size: 24px; font-weight: bold;">${campaignStats.avg_quality_score ? campaignStats.avg_quality_score.toFixed(1) : 'N/A'}</div>
                                    <div style="opacity: 0.9;">Avg Score</div>
                                </div>
                                ${campaignStats.enhanced_features ? '<div><div style="font-size: 24px; font-weight: bold;">✨</div><div style="opacity: 0.9;">Enhanced</div></div>' : ''}
                            </div>
                        </div>
                        
                        ${result.candidates && result.candidates.length > 0 ? `
                            <div style="margin-bottom: 16px;">
                                <h4>Top Candidates Added:</h4>
                            </div>
                            <div style="display: grid; gap: 16px;">
                                ${result.candidates.slice(0, 5).map(candidate => `
                                    <div style="background: white; padding: 16px; border-radius: 12px; border: 1px solid #e5e5e7; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 12px;">
                                            <div>
                                                <h4 style="margin: 0 0 4px 0; color: var(--dark-blue);">${candidate.name}</h4>
                                                <div style="color: var(--text-secondary); font-size: 14px;">
                                                    ${candidate.match_score ? `🎯 ${candidate.match_score.toFixed(1)}% Match` : ''}
                                                </div>
                                            </div>
                                            <div style="background: var(--light-green); color: var(--dark-green); padding: 4px 8px; border-radius: 16px; font-size: 12px; font-weight: 500;">
                                                NEW
                                            </div>
                                        </div>
                                        <div style="color: var(--text-secondary); font-size: 14px; line-height: 1.4;">
                                            Added to candidate pipeline • Ready for review
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            ${result.candidates.length > 5 ? `
                                <div style="text-align: center; margin-top: 16px;">
                                    <button class="btn btn-secondary" onclick="showPage('candidates')">
                                        View All ${result.candidates.length} Candidates
                                    </button>
                                </div>
                            ` : ''}
                        ` : ''}
                    `;
                } else {
                    showNotification(result.error || 'AI sourcing failed', 'error');
                    resultsDiv.innerHTML = `
                        <div style="background: linear-gradient(135deg, var(--red), #d32f2f); color: white; padding: 20px; border-radius: 12px;">
                            <h3>⚠️ Sourcing Failed</h3>
                            <p style="margin: 12px 0;">${result.error || 'Unknown error occurred'}</p>
                            <div style="margin-top: 16px;">
                                <button class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);" onclick="startAISourcing()">
                                    Try Again
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                // Refresh dashboard stats
                loadDashboard();
                
            } catch (error) {
                console.error('AI Sourcing error:', error);
                showNotification('Failed to connect to AI sourcing service', 'error');
                resultsDiv.innerHTML = `
                    <div style="background: linear-gradient(135deg, var(--red), #d32f2f); color: white; padding: 20px; border-radius: 12px;">
                        <h3>🔌 Connection Error</h3>
                        <p style="margin: 12px 0;">Failed to connect to AI sourcing service.</p>
                        <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin: 16px 0;">
                            <p style="margin: 0; font-size: 14px;">Please check:</p>
                            <ul style="margin: 8px 0; padding-left: 20px; font-size: 14px;">
                                <li>AI is configured in Settings</li>
                                <li>Valid API key is provided</li>
                                <li>Internet connection is stable</li>
                            </ul>
                        </div>
                        <div style="margin-top: 16px;">
                            <button class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); margin-right: 8px;" onclick="showPage('settings')">
                                Check Settings
                            </button>
                            <button class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);" onclick="startAISourcing()">
                                Try Again
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // Gemini AI Sourcing Functions
        async function executeGeminiSourcing(positionId, details, selectedPlatforms) {
            const resultsDiv = document.getElementById('sourcingResults');
            const progressDiv = document.getElementById('sourcingProgress');
            
            try {
                // Step 1: Validate configuration and gather requirements
                progressDiv.innerHTML = '🔍 Analyzing requirements...';
                
                let requirements = {};
                if (positionId) {
                    // Get position details from the selected position
                    const position = await getPositionDetails(positionId);
                    if (position) {
                        requirements = {
                            title: position.title,
                            skills: position.skills_required || [],
                            experience_min: position.experience_min || 0,
                            experience_max: position.experience_max || 10,
                            location: position.location,
                            department: position.department
                        };
                    }
                } else if (details) {
                    // Parse manual details - basic parsing for demonstration
                    requirements = {
                        title: extractJobTitle(details) || 'Professional',
                        skills: extractSkills(details),
                        description: details
                    };
                }
                
                // Step 2: Execute intelligent sourcing workflow
                progressDiv.innerHTML = '🧠 Generating intelligent search strategy with Gemini AI...';
                
                const sourcingResponse = await fetch('/api/ai/sourcing/gemini/intelligent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        position_id: positionId,
                        requirements: requirements,
                        target_count: 50,
                        remote_preference: false,
                        target_companies: []
                    })
                });
                
                const sourcingResult = await sourcingResponse.json();
                
                if (!sourcingResult.success) {
                    throw new Error(sourcingResult.error || 'Failed to generate sourcing strategy');
                }
                
                // Step 3: Display results
                progressDiv.innerHTML = '✅ Strategy generated successfully!';
                
                setTimeout(() => {
                    displayGeminiSourcingResults(sourcingResult, selectedPlatforms);
                }, 1000);
                
            } catch (error) {
                console.error('Gemini sourcing error:', error);
                showNotification(`Gemini AI sourcing failed: ${error.message}`, 'error');
                
                resultsDiv.innerHTML = `
                    <div style="background: linear-gradient(135deg, var(--red), #d32f2f); color: white; padding: 20px; border-radius: 12px;">
                        <h3>🚫 Gemini AI Sourcing Failed</h3>
                        <p style="margin: 12px 0;">Unable to generate intelligent sourcing strategy.</p>
                        <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin: 16px 0;">
                            <p style="margin: 0; font-size: 14px;"><strong>Error:</strong> ${error.message}</p>
                        </div>
                        <div style="margin-top: 16px;">
                            <button class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);" onclick="startAISourcing()">
                                Try Again
                            </button>
                        </div>
                    </div>
                `;
            }
        }
        
        function displayGeminiSourcingResults(results, selectedPlatforms) {
            const resultsDiv = document.getElementById('sourcingResults');
            const { search_keywords, xray_queries, sourcing_strategy, recommendations } = results.results;
            
            resultsDiv.innerHTML = `
                <div style="background: linear-gradient(135deg, var(--teal), var(--dark-teal)); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h3>🧠 Gemini AI Sourcing Strategy Generated!</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-top: 16px;">
                        <div>
                            <div style="font-size: 24px; font-weight: bold;">${xray_queries.queries.length}</div>
                            <div style="opacity: 0.9;">X-ray Queries</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: bold;">${Object.keys(search_keywords.platforms).length}</div>
                            <div style="opacity: 0.9;">Platforms</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: bold;">${sourcing_strategy.estimated_reach}</div>
                            <div style="opacity: 0.9;">Est. Reach</div>
                        </div>
                    </div>
                </div>
                
                <!-- Search Keywords Section -->
                <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h4 style="color: var(--primary-dark); margin-bottom: 16px;">
                        🎯 Search Keywords (Generated by Gemini)
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div>
                            <h5 style="color: var(--teal); margin-bottom: 8px;">Primary Keywords</h5>
                            <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                                ${search_keywords.primary.map(keyword => 
                                    `<span style="background: var(--light-blue); color: var(--dark-teal); padding: 4px 8px; border-radius: 16px; font-size: 12px;">${keyword}</span>`
                                ).join('')}
                            </div>
                        </div>
                        <div>
                            <h5 style="color: var(--teal); margin-bottom: 8px;">Secondary Keywords</h5>
                            <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                                ${search_keywords.secondary.map(keyword => 
                                    `<span style="background: var(--lighter-gray); color: var(--primary-dark); padding: 4px 8px; border-radius: 16px; font-size: 12px;">${keyword}</span>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Platform Keywords Section -->
                <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h4 style="color: var(--primary-dark); margin-bottom: 16px;">
                        🌐 Platform-Specific Keywords
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
                        ${Object.entries(search_keywords.platforms).map(([platform, keywords]) => `
                            <div>
                                <h6 style="color: var(--teal); margin-bottom: 8px; text-transform: capitalize;">${platform}</h6>
                                <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                                    ${keywords.slice(0, 3).map(keyword => 
                                        `<span style="background: var(--light-blue); color: var(--dark-teal); padding: 2px 6px; border-radius: 12px; font-size: 11px;">${keyword}</span>`
                                    ).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- X-ray Queries Section -->
                <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h4 style="color: var(--primary-dark); margin-bottom: 16px;">
                        🔍 Google X-ray Search Queries
                    </h4>
                    <p style="color: var(--gray); margin-bottom: 16px;">${xray_queries.explanation}</p>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        ${xray_queries.queries.map((query, index) => `
                            <div style="background: var(--lighter-gray); padding: 12px; border-radius: 8px; position: relative;">
                                <div style="font-family: monospace; font-size: 14px; word-break: break-all; margin-bottom: 8px;">${query}</div>
                                <button class="btn btn-sm" style="background: var(--teal); color: white; padding: 4px 12px; font-size: 12px;" 
                                        onclick="copyToClipboard('${query.replace(/'/g, "\\'")}')">
                                    Copy Query
                                </button>
                                <button class="btn btn-sm" style="background: var(--dark-teal); color: white; padding: 4px 12px; font-size: 12px; margin-left: 8px;" 
                                        onclick="executeXraySearch('${query.replace(/'/g, "\\'")}')">
                                    Execute Search
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- Recommendations Section -->
                <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h4 style="color: var(--primary-dark); margin-bottom: 16px;">
                        💡 AI Recommendations
                    </h4>
                    <ul style="color: var(--gray); margin: 0; padding-left: 20px;">
                        ${recommendations.map(rec => `<li style="margin-bottom: 8px;">${rec}</li>`).join('')}
                    </ul>
                </div>
                
                <!-- Action Buttons -->
                <div style="display: flex; gap: 12px; justify-content: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="generateMoreQueries()" style="background: var(--teal);">
                        Generate More Queries
                    </button>
                    <button class="btn btn-secondary" onclick="exportSourcingResults()" style="background: var(--dark-teal);">
                        Export Results
                    </button>
                    <button class="btn btn-outline" onclick="startAISourcing()" style="border-color: var(--teal); color: var(--teal);">
                        Start New Search
                    </button>
                </div>
            `;
            
            showNotification('Gemini AI sourcing strategy generated successfully!', 'success');
        }
        
        // Helper functions for Gemini sourcing
        async function getPositionDetails(positionId) {
            try {
                const response = await fetch(`/api/positions/${positionId}`);
                if (response.ok) {
                    const result = await response.json();
                    return result.position;
                }
            } catch (error) {
                console.error('Error fetching position details:', error);
            }
            return null;
        }
        
        function extractJobTitle(text) {
            // Simple job title extraction - can be enhanced
            const titlePatterns = [
                /(?:looking for|hiring|seeking)\s+(?:a\s+)?([^.]+?)(?:\s+to|\s+for|\s+at|$)/i,
                /([^.]+?)\s+(?:position|role|job)/i,
                /^([^.]+?)(?:\s+needed|\s+required|$)/i
            ];
            
            for (const pattern of titlePatterns) {
                const match = text.match(pattern);
                if (match && match[1]) {
                    return match[1].trim();
                }
            }
            return null;
        }
        
        function extractSkills(text) {
            // Simple skill extraction - can be enhanced
            const skillPatterns = [
                /(?:skills?|technologies?|experience)\s+(?:in\s+|with\s+)?([^.]+)/i,
                /(?:knowledge of|proficient in|expert in)\s+([^.]+)/i
            ];
            
            const skills = [];
            for (const pattern of skillPatterns) {
                const match = text.match(pattern);
                if (match && match[1]) {
                    skills.push(...match[1].split(/[,&]+/).map(s => s.trim()));
                }
            }
            return skills.slice(0, 5); // Limit to 5 skills
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('Query copied to clipboard!', 'success');
            }).catch(() => {
                showNotification('Failed to copy to clipboard', 'error');
            });
        }
        
        function executeXraySearch(query) {
            const encodedQuery = encodeURIComponent(query);
            window.open(`https://www.google.com/search?q=${encodedQuery}`, '_blank');
            showNotification('X-ray search opened in new tab', 'info');
        }
        
        function generateMoreQueries() {
            showNotification('Generating additional queries...', 'info');
            startAISourcing(); // Restart the process
        }
        
        function exportSourcingResults() {
            showNotification('Export functionality coming soon!', 'info');
        }

        // Chatbot
        function toggleChatbot() {
            const window = document.getElementById('chatbotWindow');
            window.classList.toggle('active');
            
            if (!chatSessionId && window.classList.contains('active')) {
                chatSessionId = generateSessionId();
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addChatMessage(message, 'user');
            input.value = '';
            
            // Send to backend
            try {
                const response = await fetch('/api/chatbot/message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: chatSessionId,
                        message: message,
                        api_key: apiKey
                    })
                });
                
                const result = await response.json();
                addChatMessage(result.response, 'bot');
                
            } catch (error) {
                addChatMessage('Sorry, I encountered an error. Please try again.', 'bot');
            }
        }

        function addChatMessage(message, sender) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            messageDiv.innerHTML = `<div class="chat-bubble">${message}</div>`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Drag and Drop for Pipeline
        function initializeDragAndDrop() {
            let draggedElement = null;
            
            document.addEventListener('dragstart', function(e) {
                if (e.target.classList.contains('candidate-card')) {
                    draggedElement = e.target;
                    e.target.classList.add('dragging');
                }
            });
            
            document.addEventListener('dragend', function(e) {
                if (e.target.classList.contains('candidate-card')) {
                    e.target.classList.remove('dragging');
                }
            });
            
            document.querySelectorAll('.pipeline-cards').forEach(container => {
                container.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(container, e.clientY);
                    if (afterElement == null) {
                        container.appendChild(draggedElement);
                    } else {
                        container.insertBefore(draggedElement, afterElement);
                    }
                });
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.candidate-card:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // Utility functions
        function getActivityIcon(type) {
            const icons = {
                'ai_sourcing': '🤖',
                'candidate_added': '👤',
                'stage_change': '➡️',
                'interview_scheduled': '📅',
                'offer_sent': '💌',
                'candidate_hired': '✅'
            };
            return icons[type] || '📌';
        }

        function getRelativeTime(timestamp) {
            const now = new Date();
            const then = new Date(timestamp);
            const diff = Math.floor((now - then) / 1000);
            
            if (diff < 60) return 'just now';
            if (diff < 3600) return Math.floor(diff / 60) + ' minutes ago';
            if (diff < 86400) return Math.floor(diff / 3600) + ' hours ago';
            return Math.floor(diff / 86400) + ' days ago';
        }

        function generateSessionId() {
            return 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        // Event listeners
        function setupEventListeners() {
            // Form submissions
            document.getElementById('createPositionForm')?.addEventListener('submit', async function(e) {
                e.preventDefault();
                // Handle form submission
                const formData = new FormData(e.target);
                // Send to API
                closeModal('createPositionModal');
            });

            // Edit Position Form Handler
            document.getElementById('editPositionForm')?.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const positionId = document.getElementById('editPositionId').value;
                const positionData = {
                    title: document.getElementById('editPositionTitle').value,
                    department: document.getElementById('editPositionDepartment').value,
                    location: document.getElementById('editPositionLocation').value,
                    employment_type: document.getElementById('editPositionType').value,
                    experience_min: parseInt(document.getElementById('editPositionExpMin').value) || null,
                    experience_max: parseInt(document.getElementById('editPositionExpMax').value) || null,
                    salary_min: parseFloat(document.getElementById('editPositionSalaryMin').value) || null,
                    salary_max: parseFloat(document.getElementById('editPositionSalaryMax').value) || null,
                    status: document.getElementById('editPositionStatus').value,
                    priority: document.getElementById('editPositionPriority').value,
                    openings: parseInt(document.getElementById('editPositionOpenings').value) || 1,
                    description: document.getElementById('editPositionDescription').value,
                    requirements: document.getElementById('editPositionRequirements').value,
                    responsibilities: document.getElementById('editPositionResponsibilities').value,
                    skills_required: document.getElementById('editPositionSkills').value.split(',').map(s => s.trim()).filter(s => s)
                };
                
                try {
                    const response = await fetch(`/api/positions/${positionId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(positionData)
                    });
                    
                    if (response.ok) {
                        showNotification('Position updated successfully', 'success');
                        closeModal('editPositionModal');
                        loadPositions(); // Reload the positions list
                    } else {
                        const error = await response.json();
                        showNotification(error.error || 'Failed to update position', 'error');
                    }
                } catch (error) {
                    console.error('Error updating position:', error);
                    showNotification('Failed to update position', 'error');
                }
            });

            // Edit Candidate Form Handler
            document.getElementById('editCandidateForm')?.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const candidateId = document.getElementById('editCandidateId').value;
                const candidateData = {
                    first_name: document.getElementById('editCandidateFirstName').value,
                    last_name: document.getElementById('editCandidateLastName').value,
                    email: document.getElementById('editCandidateEmail').value,
                    phone: document.getElementById('editCandidatePhone').value,
                    location: document.getElementById('editCandidateLocation').value,
                    current_position: document.getElementById('editCandidateCurrentPosition').value,
                    experience_years: parseInt(document.getElementById('editCandidateExperience').value) || null,
                    expected_salary: parseFloat(document.getElementById('editCandidateExpectedSalary').value) || null,
                    status: document.getElementById('editCandidateStatus').value,
                    source: document.getElementById('editCandidateSource').value,
                    skills: document.getElementById('editCandidateSkills').value.split(',').map(s => s.trim()).filter(s => s),
                    notes: document.getElementById('editCandidateNotes').value
                };
                
                try {
                    const response = await fetch(`/api/candidates/${candidateId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(candidateData)
                    });
                    
                    if (response.ok) {
                        showNotification('Candidate updated successfully', 'success');
                        closeModal('editCandidateModal');
                        loadCandidates(); // Reload the candidates list
                    } else {
                        const error = await response.json();
                        showNotification(error.error || 'Failed to update candidate', 'error');
                    }
                } catch (error) {
                    console.error('Error updating candidate:', error);
                    showNotification('Failed to update candidate', 'error');
                }
            });
        }

        // Initialize charts (placeholder)
        function initializeCharts() {
            // Would integrate with Chart.js or similar library
            console.log('Charts initialized');
        }

        // Project Document Management Functions
        let projectDocuments = [];

        async function addProjectDocument() {
            const fileInput = document.getElementById('projectDocumentFile');
            const titleInput = document.getElementById('projectDocumentTitle');
            const typeSelect = document.getElementById('projectDocumentType');
            const descriptionInput = document.getElementById('projectDocumentDescription');
            
            const files = fileInput.files;
            if (files.length === 0) {
                alert('Please select at least one file to upload.');
                return;
            }
            
            const title = titleInput.value.trim();
            if (!title) {
                alert('Please enter a document title.');
                return;
            }
            
            // Get current project ID if we're editing a project
            const currentProjectId = getCurrentProjectId();
            
            // Process each selected file
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                if (currentProjectId) {
                    // Upload to existing project with AI analysis
                    await uploadFileToProject(file, currentProjectId, {
                        title: i === 0 ? title : `${title} (${i + 1})`,
                        type: typeSelect.value,
                        description: descriptionInput.value.trim()
                    });
                } else {
                    // For new projects, store locally for now
                    const document = {
                        id: generateDocumentId(),
                        file: file,
                        title: i === 0 ? title : `${title} (${i + 1})`,
                        type: typeSelect.value,
                        description: descriptionInput.value.trim(),
                        size: formatFileSize(file.size),
                        uploadDate: new Date().toISOString(),
                        pendingUpload: true
                    };
                    
                    projectDocuments.push(document);
                }
            }
            
            // Clear form fields
            fileInput.value = '';
            titleInput.value = '';
            descriptionInput.value = '';
            
            // Update the documents list display
            updateProjectDocumentsList();
        }
        
        async function uploadFileToProject(file, projectId, metadata) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('type', metadata.type);
            formData.append('description', metadata.description);
            formData.append('api_key', apiKey);
            
            try {
                const response = await fetch(`/api/projects/${projectId}/documents`, {
                    method: 'POST',
                    headers: {
                        'X-API-Key': apiKey
                    },
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Show success message
                    showNotification(`Document "${file.name}" uploaded and analyzed successfully!`, 'success');
                    
                    // Show AI analysis results if job descriptions were found
                    if (result.document && result.document.job_descriptions && result.document.job_descriptions.length > 0) {
                        showJobDescriptionAnalysisModal(result.document);
                    }
                    
                    // Refresh project view if needed
                    if (typeof loadProjects === 'function') {
                        loadProjects();
                    }
                    
                } else {
                    const error = await response.json();
                    alert(`Upload failed for "${file.name}": ` + (error.error || 'Unknown error'));
                }
                
            } catch (error) {
                console.error('Upload error:', error);
                alert(`Upload failed for "${file.name}": ` + error.message);
            }
        }
        
        function getCurrentProjectId() {
            // Check if we're in a project view/edit modal
            const projectModal = document.querySelector('.modal-overlay .project-details-modal, .modal-overlay .project-edit-modal');
            if (projectModal) {
                // Extract project ID from modal content or buttons
                const editButton = projectModal.querySelector('button[onclick*="editProject"]');
                if (editButton) {
                    const match = editButton.getAttribute('onclick').match(/editProject\('([^']+)'\)/);
                    if (match) return match[1];
                }
            }
            return null; // Return null for new projects
        }

        function showAddDocumentModal(projectId) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content add-document-modal">
                    <div class="modal-header">
                        <h2>📎 Add Document to Project</h2>
                        <button class="modal-close" onclick="closeModal(this)">&times;</button>
                    </div>
                    <form onsubmit="uploadDocumentToProject(event, '${projectId}')">
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="addDocFile">Select File *</label>
                                <input type="file" id="addDocFile" required accept=".pdf,.doc,.docx,.txt,.csv,.xlsx">
                            </div>
                            <div class="form-group">
                                <label for="addDocType">Document Type</label>
                                <select id="addDocType" required>
                                    <option value="job_description">Job Description</option>
                                    <option value="requirements">Requirements</option>
                                    <option value="contract">Contract</option>
                                    <option value="resume">Resume/CV</option>
                                    <option value="report">Report</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="addDocDescription">Description (Optional)</label>
                                <textarea id="addDocDescription" rows="3" placeholder="Add notes about this document..."></textarea>
                            </div>
                            <div class="ai-notice">
                                <p>🤖 <strong>AI Analysis:</strong> This document will be automatically analyzed for job descriptions. If any are found, positions will be created automatically.</p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">🤖 Upload & Analyze</button>
                            <button type="button" class="btn btn-secondary" onclick="closeModal(this)">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function uploadDocumentToProject(event, projectId) {
            event.preventDefault();
            
            const fileInput = document.getElementById('addDocFile');
            const typeSelect = document.getElementById('addDocType');
            const descriptionTextarea = document.getElementById('addDocDescription');
            
            if (!fileInput.files[0]) {
                alert('Please select a file');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('type', typeSelect.value);
            formData.append('description', descriptionTextarea.value);
            formData.append('api_key', apiKey);
            
            try {
                const submitButton = event.target.querySelector('button[type="submit"]');
                submitButton.textContent = '🤖 Analyzing Document...';
                submitButton.disabled = true;
                
                const response = await fetch(`/api/projects/${projectId}/documents`, {
                    method: 'POST',
                    headers: {
                        'X-API-Key': apiKey
                    },
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Close the add document modal
                    closeModal(submitButton);
                    
                    // Show success message
                    showNotification('Document uploaded and analyzed successfully!', 'success');
                    
                    // Show AI analysis results if job descriptions were found
                    if (result.document && result.document.job_descriptions && result.document.job_descriptions.length > 0) {
                        showJobDescriptionAnalysisModal(result.document);
                    }
                    
                    // Refresh the project details modal
                    const currentProjectModal = document.querySelector('.project-details-modal');
                    if (currentProjectModal) {
                        closeModal(currentProjectModal);
                        // Reload the project details
                        setTimeout(() => viewProject(projectId), 500);
                    }
                    
                    // Refresh projects list
                    if (typeof loadProjects === 'function') {
                        loadProjects();
                    }
                    
                } else {
                    console.error('Response status:', response.status);
                    console.error('Response headers:', response.headers);
                    const responseText = await response.text();
                    console.error('Response body:', responseText);
                    
                    let errorMessage = 'Unknown error';
                    try {
                        const error = JSON.parse(responseText);
                        errorMessage = error.error || error.message || 'Unknown error';
                    } catch (parseError) {
                        errorMessage = `Server error: ${response.status} ${response.statusText}`;
                        if (responseText.includes('<!doctype') || responseText.includes('<html>')) {
                            errorMessage += ' (Server returned HTML instead of JSON - check server logs)';
                        }
                    }
                    alert('Upload failed: ' + errorMessage);
                }
                
            } catch (error) {
                console.error('Upload error:', error);
                alert('Upload failed: ' + error.message);
            } finally {
                const submitButton = event.target.querySelector('button[type="submit"]');
                submitButton.textContent = '🤖 Upload & Analyze';
                submitButton.disabled = false;
            }
        }
        
        function updateProjectDocumentsList() {
            const container = document.querySelector('#projectDocumentsList .uploaded-documents');
            
            if (!container) {
                console.warn('Project documents container not found');
                return;
            }
            
            if (projectDocuments.length === 0) {
                container.innerHTML = '<div class="empty-documents">No documents added yet. Click "Add Document" to upload files.</div>';
                return;
            }
            
            const documentsHtml = projectDocuments.map(doc => `
                <div class="document-item" data-doc-id="${doc.id}">
                    <div class="document-info">
                        <div class="document-icon">${getDocumentIcon(doc.type)}</div>
                        <div class="document-details">
                            <h4>${doc.title}</h4>
                            <p>${doc.type} • ${doc.size} • ${doc.file.name}</p>
                        </div>
                    </div>
                    <div class="document-actions">
                        <button class="btn btn-small btn-danger" onclick="removeProjectDocument('${doc.id}')">Remove</button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = documentsHtml;
        }
        
        function removeProjectDocument(docId) {
            projectDocuments = projectDocuments.filter(doc => doc.id !== docId);
            updateProjectDocumentsList();
        }
        
        function getDocumentIcon(type) {
            const icons = {
                'requirements': '📋',
                'timeline': '📅',
                'budget': '💰',
                'job-descriptions': '📄',
                'team-notes': '📝',
                'contracts': '📜',
                'reports': '📊',
                'other': '📁'
            };
            return icons[type] || '📁';
        }
        
        function generateDocumentId() {
            return 'doc_' + Math.random().toString(36).substr(2, 9);
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        async function createProjectWithDocuments() {
            const projectName = document.getElementById('projectName').value.trim();
            const projectType = document.getElementById('projectType').value;
            const projectDescription = document.getElementById('projectDescription').value.trim();
            
            if (!projectName) {
                alert('Please enter a project name.');
                return;
            }
            
            const projectData = {
                name: projectName,
                type: projectType,
                description: projectDescription,
                documents: projectDocuments.map(doc => ({
                    title: doc.title,
                    type: doc.type,
                    description: doc.description,
                    filename: doc.file.name,
                    size: doc.file.size
                })),
                status: 'Active'
            };
            
            try {
                const response = await fetch('/api/projects', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey
                    },
                    body: JSON.stringify(projectData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Reset form
                    document.getElementById('projectName').value = '';
                    document.getElementById('projectDescription').value = '';
                    document.getElementById('projectType').selectedIndex = 0;
                    projectDocuments = [];
                    updateProjectDocumentsList();
                    
                    alert(`Project "${projectName}" created successfully with ${projectData.documents.length} documents!`);
                    
                    // Refresh projects list
                    loadProjects();
                } else {
                    alert('Error creating project: ' + (result.error || 'Unknown error'));
                }
                
            } catch (error) {
                console.error('Error creating project:', error);
                alert('Error creating project. Please try again.');
            }
        }
        
        async function loadProjects() {
            try {
                const response = await fetch('/api/projects');
                if (response.ok) {
                    const projects = await response.json();
                    displayProjects(projects);
                    updateProjectStats(projects);
                } else {
                    console.error('Failed to load projects');
                }
            } catch (error) {
                console.error('Error loading projects:', error);
            }
        }
        
        // Enhanced Project Modal Functions
        function openCreateProjectModal() {
            document.getElementById('createProjectModal').classList.add('active');
            // Reset form
            document.getElementById('createProjectForm').reset();
            document.getElementById('uploadedDocumentsList').innerHTML = '';
        }

        function handleProjectDocumentUpload(input) {
            const files = input.files;
            const listContainer = document.getElementById('uploadedDocumentsList');
            
            if (files.length > 0) {
                let html = '<div style="margin-top: 12px;"><h5>Documents to Upload:</h5>';
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    html += `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--background-secondary); border-radius: 6px; margin-bottom: 4px;">
                            <span>📄</span>
                            <span style="flex: 1;">${file.name}</span>
                            <span style="font-size: 12px; color: var(--text-secondary);">${(file.size / 1024 / 1024).toFixed(1)} MB</span>
                        </div>
                    `;
                }
                html += '</div>';
                listContainer.innerHTML = html;
            }
        }

        // Enhanced Project Filtering
        function clearProjectFilters() {
            document.getElementById('projectSearchInput').value = '';
            document.getElementById('projectStatusFilter').value = '';
            document.getElementById('projectTypeFilter').value = '';
            loadProjects(); // Reload all projects
        }

        function displayProjects(projects) {
            const container = document.getElementById('projectsContainer');
            const emptyState = document.getElementById('projectsEmptyState');
            
            if (!container) return;
            
            if (projects.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            container.style.display = 'grid';
            emptyState.style.display = 'none';
            
            container.innerHTML = projects.map(project => {
                const statusColors = {
                    active: 'var(--green)',
                    completed: 'var(--teal)',
                    'on-hold': 'var(--orange)',
                    planning: 'var(--purple)'
                };
                
                const priorityColors = {
                    Low: 'var(--text-secondary)',
                    Medium: 'var(--orange)',
                    High: 'var(--red)',
                    Urgent: 'var(--red)'
                };
                
                return `
                    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid var(--border-color); transition: transform 0.2s, box-shadow 0.2s;" 
                         onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 16px rgba(0,0,0,0.15)'"
                         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
                        
                        <!-- Project Header -->
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 8px 0; color: var(--dark-blue); font-size: 18px;">${project.name}</h3>
                                <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                    <span style="background: var(--light-blue); color: var(--dark-blue); padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                                        ${project.type || 'General'}
                                    </span>
                                    <span style="background: ${statusColors[project.status || 'active']}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                                        ${(project.status || 'active').charAt(0).toUpperCase() + (project.status || 'active').slice(1)}
                                    </span>
                                    ${project.priority ? `
                                        <span style="color: ${priorityColors[project.priority]}; font-size: 12px; font-weight: 500;">
                                            ${project.priority} Priority
                                        </span>
                                    ` : ''}
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="viewProject('${project.id}')">View</button>
                                <button class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;" onclick="editProject('${project.id}')">Edit</button>
                            </div>
                        </div>
                        
                        <!-- Project Description -->
                        <div style="margin-bottom: 16px;">
                            <p style="margin: 0; color: var(--text-secondary); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                ${project.description || 'No description provided'}
                            </p>
                        </div>
                        
                        <!-- Project Stats -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 12px; margin-bottom: 16px; padding: 12px; background: var(--background-secondary); border-radius: 8px;">
                            <div style="text-align: center;">
                                <div style="font-size: 18px; font-weight: 600; color: var(--dark-blue);">${project.positions_count || 0}</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Positions</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 18px; font-weight: 600; color: var(--dark-blue);">${project.candidates_count || 0}</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Candidates</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 18px; font-weight: 600; color: var(--dark-blue);">${project.documents_count || 0}</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Documents</div>
                            </div>
                        </div>
                        
                        <!-- Project Meta -->
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--text-secondary);">
                            <span>Created: ${new Date(project.created_at || Date.now()).toLocaleDateString()}</span>
                            <span>Updated: ${new Date(project.updated_at || project.created_at || Date.now()).toLocaleDateString()}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateProjectStats(projects) {
            document.getElementById('totalProjects').textContent = projects.length;
            document.getElementById('activeProjects').textContent = projects.filter(p => p.status === 'active').length;
            document.getElementById('completedProjects').textContent = projects.filter(p => p.status === 'completed').length;
            
            // Calculate total positions across all projects
            const totalPositions = projects.reduce((sum, project) => sum + (project.positions_count || 0), 0);
            document.getElementById('totalPositions').textContent = totalPositions;
        }

        // Enhanced form handler for creating projects
        document.getElementById('createProjectForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('projectName').value.trim(),
                type: document.getElementById('projectType').value,
                priority: document.getElementById('projectPriority').value,
                status: document.getElementById('projectStatus').value,
                description: document.getElementById('projectDescription').value.trim()
            };
            
            if (!formData.name || !formData.type) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/projects', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    showNotification('Project created successfully!', 'success');
                    closeModal('createProjectModal');
                    loadProjects(); // Reload projects
                    
                    // Handle document upload if files were selected
                    const fileInput = document.getElementById('projectDocumentFile');
                    if (fileInput.files.length > 0) {
                        // Note: Document upload would need to be implemented separately
                        showNotification('Project created. Document upload feature coming soon!', 'info');
                    }
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to create project', 'error');
                }
            } catch (error) {
                console.error('Error creating project:', error);
                showNotification('Failed to create project', 'error');
            }
        });
        
        function updateProjectStats(projects) {
            const totalProjects = projects.length;
            const activeProjects = projects.filter(p => p.status === 'active' || !p.status).length;
            const completedProjects = projects.filter(p => p.status === 'completed').length;
            
            document.getElementById('totalProjects').textContent = totalProjects;
            document.getElementById('activeProjects').textContent = activeProjects;
            document.getElementById('completedProjects').textContent = completedProjects;
        }
        
        function getDocumentIcon(type) {
            const icons = {
                'requirements': '📋',
                'timeline': '📅',
                'budget': '💰',
                'job-descriptions': '💼',
                'team-notes': '📝',
                'contracts': '📄',
                'reports': '📊',
                'other': '📁'
            };
            return icons[type] || '📄';
        }
        
        async function viewProject(projectId) {
            try {
                const response = await fetch(`/api/projects/${projectId}`);
                if (response.ok) {
                    const project = await response.json();
                    showProjectDetailsModal(project);
                } else {
                    alert('Error loading project details');
                }
            } catch (error) {
                console.error('Error viewing project:', error);
                alert('Error loading project details');
            }
        }
        
        async function editProject(projectId) {
            try {
                const response = await fetch(`/api/projects/${projectId}`);
                if (response.ok) {
                    const project = await response.json();
                    showProjectEditModal(project);
                } else {
                    alert('Error loading project details');
                }
            } catch (error) {
                console.error('Error loading project:', error);
                alert('Error loading project details');
            }
        }
        
        async function downloadDocument(docId, filename) {
		try {
			const response = await fetch(`/api/documents/${docId}/download`);
			
			if (!response.ok) {
				throw new Error('Download failed');
			}
			
			// Get the file blob
			const blob = await response.blob();
			
			// Create download link
			const url = window.URL.createObjectURL(blob);
			const link = document.createElement('a');
			link.href = url;
			link.download = filename;
			link.click();
			
			// Cleanup
			window.URL.revokeObjectURL(url);
			
		} catch (error) {
			console.error('Download error:', error);
			alert('Failed to download document');
		}
	} 
			
        function viewDocument(docId) {
            // Open document in new tab
            window.open(`/api/documents/${docId}/view`, '_blank');
        }

        function showProjectDetailsModal(project) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content project-details-modal">
                    <div class="modal-header">
                        <h2>Project Details</h2>
                        <button class="modal-close" onclick="closeModal(this)">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="project-info">
                            <h3>${project.name}</h3>
                            <p><strong>Status:</strong> <span class="status-badge status-${project.status.toLowerCase()}">${project.status}</span></p>
                            <p><strong>Client:</strong> ${project.client || 'Not specified'}</p>
                            <p><strong>Created:</strong> ${new Date(project.created).toLocaleDateString()}</p>
                            <p><strong>Description:</strong> ${project.description || 'No description provided'}</p>
                        </div>
                        <div class="project-documents">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h4>Documents (${project.document_count || 0})</h4>
                                <button class="btn btn-small btn-primary" onclick="showAddDocumentModal('${project.id}')">+ Add Document</button>
                            </div>
                            <div class="documents-list">
                                ${project.documents && project.documents.length > 0 
                                    ? project.documents.map(doc => `
                                        <div class="document-item">
                                            <span class="document-icon">${getDocumentIcon(doc.type)}</span>
                                            <span class="document-name">${doc.filename}</span>
                                            <button class="btn btn-small" onclick="downloadDocument('${doc.id}', '${doc.filename}')">Download</button>
                                        </div>
                                    `).join('')
                                    : '<p>No documents uploaded yet.</p>'
                                }
                            </div>
                        </div>
                        <div class="project-positions">
                            <h4>Positions (${project.positions ? project.positions.length : 0})</h4>
                            <div class="positions-list">
                                ${project.positions && project.positions.length > 0
                                    ? project.positions.map(pos => `<div class="position-item">${pos.title}</div>`).join('')
                                    : '<p>No positions created yet.</p>'
                                }
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" onclick="editProject('${project.id}'); closeModal(this)">Edit Project</button>
                        <button class="btn btn-danger" onclick="confirmDeleteProject('${project.id}', '${project.name}')">Delete Project</button>
                        <button class="btn btn-secondary" onclick="closeModal(this)">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showProjectEditModal(project) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content project-edit-modal">
                    <div class="modal-header">
                        <h2>Edit Project</h2>
                        <button class="modal-close" onclick="closeModal(this)">&times;</button>
                    </div>
                    <form onsubmit="updateProject(event, '${project.id}')">
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="editProjectName">Project Name *</label>
                                <input type="text" id="editProjectName" name="name" value="${project.name}" required>
                            </div>
                            <div class="form-group">
                                <label for="editProjectClient">Client</label>
                                <input type="text" id="editProjectClient" name="client" value="${project.client || ''}">
                            </div>
                            <div class="form-group">
                                <label for="editProjectStatus">Status</label>
                                <select id="editProjectStatus" name="status" required>
                                    <option value="Active" ${project.status === 'Active' ? 'selected' : ''}>Active</option>
                                    <option value="On Hold" ${project.status === 'On Hold' ? 'selected' : ''}>On Hold</option>
                                    <option value="Completed" ${project.status === 'Completed' ? 'selected' : ''}>Completed</option>
                                    <option value="Cancelled" ${project.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editProjectDescription">Description</label>
                                <textarea id="editProjectDescription" name="description" rows="3">${project.description || ''}</textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Update Project</button>
                            <button type="button" class="btn btn-secondary" onclick="closeModal(this)">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function updateProject(event, projectId) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const updateData = {
                name: formData.get('name'),
                client: formData.get('client'),
                status: formData.get('status'),
                description: formData.get('description')
            };

            try {
                const response = await fetch(`/api/projects/${projectId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey
                    },
                    body: JSON.stringify(updateData)
                });

                if (response.ok) {
                    const updatedProject = await response.json();
                    closeModal(event.target);
                    loadProjects(); // Refresh the projects list
                    showNotification('Project updated successfully!', 'success');
                } else {
                    const error = await response.json();
                    alert('Error updating project: ' + (error.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating project:', error);
                alert('Error updating project');
            }
        }

        async function uploadDocument() {
            const fileInput = document.getElementById('documentFile');
            const typeSelect = document.getElementById('documentType');
            const descriptionTextarea = document.getElementById('documentDescription');
            
            if (!fileInput.files[0]) {
                alert('Please select a file to upload');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('type', typeSelect.value);
            formData.append('description', descriptionTextarea.value);
            formData.append('project_id', ''); // Add project_id if needed
            formData.append('api_key', apiKey);
            
            try {
                const uploadButton = document.querySelector('button[onclick="uploadDocument()"]');
                uploadButton.textContent = 'Analyzing Document...';
                uploadButton.disabled = true;
                
                const response = await fetch('/api/documents/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Show upload success
                    showNotification('Document uploaded successfully!', 'success');
                    
                    // Show AI analysis results if job descriptions were found
                    if (result.document && result.document.job_descriptions && result.document.job_descriptions.length > 0) {
                        showJobDescriptionAnalysisModal(result.document);
                    }
                    
                    // Reset form
                    fileInput.value = '';
                    descriptionTextarea.value = '';
                    
                } else {
                    const error = await response.json();
                    alert('Upload failed: ' + (error.error || 'Unknown error'));
                }
                
            } catch (error) {
                console.error('Upload error:', error);
                alert('Upload failed: ' + error.message);
            } finally {
                const uploadButton = document.querySelector('button[onclick="uploadDocument()"]');
                uploadButton.textContent = 'Upload Document';
                uploadButton.disabled = false;
            }
        }

        function showJobDescriptionAnalysisModal(document) {
            const jobDescriptions = document.job_descriptions;
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content ai-analysis-modal">
                    <div class="modal-header">
                        <h2>🤖 AI Document Analysis Results</h2>
                        <button class="modal-close" onclick="closeModal(this)">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="analysis-summary">
                            <p><strong>Document:</strong> ${document.filename}</p>
                            <p><strong>Analysis:</strong> Found ${jobDescriptions.length} job description(s)</p>
                        </div>
                        
                        <div class="job-descriptions-found">
                            <h3>Job Descriptions Detected:</h3>
                            ${jobDescriptions.map((job, index) => `
                                <div class="job-description-card">
                                    <div class="job-header">
                                        <h4>${job.title}</h4>
                                        <span class="confidence-badge">Confidence: ${Math.round(job.confidence_score * 100)}%</span>
                                    </div>
                                    <div class="job-details">
                                        <p><strong>Department:</strong> ${job.department || 'Not specified'}</p>
                                        <p><strong>Location:</strong> ${job.location || 'Not specified'}</p>
                                        <p><strong>Employment Type:</strong> ${job.employment_type || 'Not specified'}</p>
                                        <p><strong>Experience Level:</strong> ${job.experience_level || 'Not specified'}</p>
                                        ${job.salary_range ? `<p><strong>Salary Range:</strong> ${job.salary_range}</p>` : ''}
                                        <p><strong>Description:</strong> ${job.description || 'Not provided'}</p>
                                        ${job.skills.length > 0 ? `<p><strong>Skills:</strong> ${job.skills.join(', ')}</p>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        ${document.created_positions && document.created_positions.length > 0 ? `
                            <div class="positions-created">
                                <h3>✅ Positions Automatically Created:</h3>
                                <ul>
                                    ${document.created_positions.map(pos => `<li>${pos.title}</li>`).join('')}
                                </ul>
                                <p><em>These positions have been added to your project and are now available in the Positions section.</em></p>
                            </div>
                        ` : ''}
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" onclick="showPage('positions'); closeModal(this)">View Positions</button>
                        <button class="btn btn-secondary" onclick="closeModal(this)">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeModal(element) {
            const modal = element.closest('.modal-overlay');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        function confirmDeleteProject(projectId, projectName) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content delete-confirmation-modal">
                    <div class="modal-header">
                        <h2>Confirm Delete Project</h2>
                        <button class="modal-close" onclick="closeModal(this)">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="warning-icon" style="text-align: center; font-size: 48px; color: var(--red); margin-bottom: 20px;">⚠️</div>
                        <p><strong>Are you sure you want to delete the project "${projectName}"?</strong></p>
                        <p>This action will permanently delete:</p>
                        <ul>
                            <li>The project and all its data</li>
                            <li>All associated documents</li>
                            <li>All positions within this project</li>
                            <li>All candidates associated with those positions</li>
                        </ul>
                        <p style="color: var(--red); font-weight: bold;">This action cannot be undone!</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-danger" onclick="deleteProject('${projectId}')">Yes, Delete Project</button>
                        <button class="btn btn-secondary" onclick="closeModal(this)">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function deleteProject(projectId) {
            try {
                const response = await fetch(`/api/projects/${projectId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-API-Key': apiKey
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    // Close all modals
                    document.querySelectorAll('.modal-overlay').forEach(modal => {
                        document.body.removeChild(modal);
                    });
                    // Refresh the projects list
                    loadProjects();
                    // Refresh dashboard stats
                    loadDashboard();
                    showNotification('Project deleted successfully!', 'success');
                } else {
                    const error = await response.json();
                    alert('Error deleting project: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting project:', error);
                alert('Error deleting project');
            }
        }
        
        // Initialize the document upload section
        document.addEventListener('DOMContentLoaded', function() {
            updateProjectDocumentsList();
        });
    </script>
    <script src="/static/js/recruitpro_fixes.js?v=2"></script>
</body>
</html>
