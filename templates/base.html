<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}{{workspace_name or 'RecruitPro'}}{% endblock %}</title>

  <!-- Preconnect to external resources -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">

  <!-- Built Tailwind CSS (replaces CDN) -->
  <link href="/static/css/output.css" rel="stylesheet">

  {% block extra_head %}{% endblock %}
</head>
<body class="h-full bg-background-dark text-text-primary antialiased">
  <!-- Skip to main content link for accessibility -->
  <a href="#main-content" class="skip-link">
    Skip to main content
  </a>

  {% block body %}
  <div class="min-h-full flex">
    {% block sidebar %}{% endblock %}

    <main id="main-content" class="flex-1 {% block main_class %}{% endblock %}">
      {% block header %}{% endblock %}

      {% block content %}{% endblock %}
    </main>
  </div>
  {% endblock %}

  <!-- Toast notification component -->
  {% include 'components/toast.html' %}

  <!-- Modal component -->
  {% include 'components/modal.html' %}

  <!-- Global scripts -->
  <script>
    // Global namespace for RecruitPro utilities
    window.RecruitPro = window.RecruitPro || {};

    // Token storage keys
    const TOKEN_STORAGE_KEY = 'recruitpro_token';
    const TOKEN_TYPE_STORAGE_KEY = 'recruitpro_token_type';

    // Get auth header for API calls
    function getAuthHeader() {
      try {
        const token = window.localStorage?.getItem(TOKEN_STORAGE_KEY);
        const tokenType = window.localStorage?.getItem(TOKEN_TYPE_STORAGE_KEY) || 'Bearer';
        return token ? `${tokenType} ${token}` : '';
      } catch (error) {
        return '';
      }
    }

    // Persist token to storage
    function persistToken(token, tokenType = 'Bearer') {
      try {
        window.localStorage?.setItem(TOKEN_STORAGE_KEY, token);
        window.localStorage?.setItem(TOKEN_TYPE_STORAGE_KEY, tokenType);
      } catch (error) {
        console.error('Failed to persist token:', error);
      }
    }

    // Clear token from storage
    function clearToken() {
      try {
        window.localStorage?.removeItem(TOKEN_STORAGE_KEY);
        window.localStorage?.removeItem(TOKEN_TYPE_STORAGE_KEY);
      } catch (error) {
        console.error('Failed to clear token:', error);
      }
    }

    // Enhanced fetch wrapper with error handling
    async function apiFetch(path, options = {}) {
      const init = { credentials: 'include', ...options };
      init.headers = new Headers(init.headers || {});

      const authHeader = getAuthHeader();
      if (authHeader) {
        init.headers.set('Authorization', authHeader);
      }

      if (options.body && typeof options.body === 'object' && !(options.body instanceof FormData)) {
        init.headers.set('Content-Type', 'application/json');
        init.body = JSON.stringify(options.body);
      }

      try {
        const response = await fetch(path, init);
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || data.detail || 'Request failed');
        }

        return data;
      } catch (error) {
        console.error('API request failed:', error);
        throw error;
      }
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Format date/time
    function formatDateTime(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleString();
    }

    // Format number with commas
    function formatNumber(num) {
      return num.toLocaleString();
    }

    // Show toast notification (wrapper for convenience)
    function showToast(options) {
      if (window.RecruitPro.showToast) {
        window.RecruitPro.showToast(options);
      } else {
        console.warn('Toast system not loaded');
      }
    }

    // Show modal (wrapper for convenience)
    function showModal(options) {
      if (window.RecruitPro.showModal) {
        window.RecruitPro.showModal(options);
      } else {
        console.warn('Modal system not loaded');
      }
    }

    // Global error handler for unhandled promise rejections
    window.addEventListener('unhandledrejection', (event) => {
      console.error('Unhandled promise rejection:', event.reason);
      showToast({
        type: 'error',
        title: 'Error',
        message: 'An unexpected error occurred. Please try again.',
        duration: 5000,
      });
    });

    // Add to global namespace
    window.RecruitPro.apiFetch = apiFetch;
    window.RecruitPro.escapeHtml = escapeHtml;
    window.RecruitPro.formatDateTime = formatDateTime;
    window.RecruitPro.formatNumber = formatNumber;
  </script>

  {% block scripts %}{% endblock %}
</body>
</html>
