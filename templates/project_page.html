<!DOCTYPE html>
<html class="dark" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>RecruitPro - {% if project %}{{ project.name }}{% else %}Project overview{% endif %}</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
      rel="stylesheet"
    />
    <script id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#1173d4",
              "background-light": "#f6f7f8",
              "background-dark": "#101922",
            },
            fontFamily: {
              display: ["Inter", "sans-serif"],
            },
            borderRadius: {
              DEFAULT: "0.25rem",
              lg: "0.5rem",
              xl: "0.75rem",
              full: "9999px",
            },
          },
        },
      };
    </script>
    <style type="text/tailwindcss">
      .material-symbols-outlined {
        font-variation-settings:
          "FILL" 0,
          "wght" 400,
          "GRAD" 0,
          "opsz" 24;
      }

      @layer components {
        .rp-card {
          @apply rounded-lg border border-[#233648] bg-[#111a22] transition-all duration-200 ease-out shadow-sm;
        }

        .rp-card:hover {
          @apply -translate-y-0.5 border-primary/40 shadow-lg shadow-primary/20;
        }

        .rp-card:focus-within {
          @apply border-primary/50 shadow-lg shadow-primary/25;
        }

        .rp-surface {
          @apply rounded-xl border border-[#233648] bg-[#111a22] transition-all duration-200 ease-out shadow-sm;
        }

        .rp-surface:hover {
          @apply border-primary/30 shadow-lg shadow-primary/20;
        }

        .rp-button {
          @apply transition-transform duration-200 ease-out shadow-sm hover:-translate-y-0.5 hover:shadow-lg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/60 focus-visible:ring-offset-2 focus-visible:ring-offset-[#101922];
        }
      }

      @media (prefers-reduced-motion: reduce) {
        .rp-card,
        .rp-surface,
        .rp-button {
          transition: none !important;
          transform: none !important;
          box-shadow: none !important;
        }
      }
    </style>
  </head>
  <body class="bg-background-dark font-display text-white">
    {% set token_query = '' %}
    {% if token %}
    {% set token_query = '&token=' + token %}
    {% endif %}
    <div class="flex h-screen w-full">
      <!-- SideNavBar -->
      <aside class="flex h-full flex-col justify-between bg-[#111a22] p-4 border-r border-r-[#233648]">
        <div class="flex flex-col gap-4">
          <div class="flex gap-3 items-center">
            <div
              class="flex size-10 items-center justify-center rounded-full bg-[#1f2d3a] text-sm font-semibold"
              aria-hidden="true"
            >
              {{ (user.initials if user else 'RP') }}
            </div>
            <div class="flex flex-col">
              <h1 class="text-white text-base font-medium leading-normal">
                {{ user.name if user else 'RecruitPro user' }}
              </h1>
              <p class="text-[#92adc9] text-sm font-normal leading-normal">
                {{ user.role if user else 'Guest' }}
              </p>
            </div>
          </div>
          <nav class="flex flex-col gap-2">
            <a
              class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-[#233648] transition-colors"
              href="/app{% if token %}?token={{ token }}{% endif %}"
            >
              <span class="material-symbols-outlined text-white text-2xl">dashboard</span>
              <p class="text-white text-sm font-medium leading-normal">Dashboard</p>
            </a>
            <a
              class="flex items-center gap-3 px-3 py-2 rounded-lg bg-[#233648]"
              href="{% if project %}/project-overview?project_id={{ project.project_id }}{% if token %}&token={{ token }}{% endif %}{% else %}#{% endif %}"
            >
              <span class="material-symbols-outlined text-white text-2xl" style="font-variation-settings: 'FILL' 1;">folder</span>
              <p class="text-white text-sm font-medium leading-normal">Projects</p>
            </a>
            <a
              class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-[#233648] transition-colors"
              href="/project-positions{% if project %}?project_id={{ project.project_id }}{% if token %}&token={{ token }}{% endif %}{% endif %}"
            >
              <span class="material-symbols-outlined text-white text-2xl">group</span>
              <p class="text-white text-sm font-medium leading-normal">Positions</p>
            </a>
            <a
              class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-[#233648] transition-colors"
              href="/ai/sourcing-overview{% if token %}?token={{ token }}{% endif %}"
            >
              <span class="material-symbols-outlined text-white text-2xl">analytics</span>
              <p class="text-white text-sm font-medium leading-normal">AI sourcing</p>
            </a>
            <a
              class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-[#233648] transition-colors"
              href="/settings{% if token %}?token={{ token }}{% endif %}"
            >
              <span class="material-symbols-outlined text-white text-2xl">settings</span>
              <p class="text-white text-sm font-medium leading-normal">Settings</p>
            </a>
          </nav>
        </div>
        <div class="flex flex-col gap-4">
          <a
            class="rp-button flex w-full cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em]"
            href="/app{% if token %}?token={{ token }}{% endif %}"
          >
            <span class="truncate">Open console</span>
          </a>
          <div class="flex flex-col gap-1">
            <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-[#233648] transition-colors" href="https://github.com/">
              <span class="material-symbols-outlined text-white text-2xl">help_outline</span>
              <p class="text-white text-sm font-medium leading-normal">Help</p>
            </a>
          </div>
        </div>
      </aside>
      <!-- Main Content -->
      <div class="flex-1 flex flex-col overflow-hidden">
        <!-- TopNavBar -->
        <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#233648] px-10 py-3 bg-[#111a22]">
          <div class="flex items-center gap-8">
            <div class="flex items-center gap-4 text-white">
              <div class="size-6 text-primary">
                <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                  <path
                    d="M42.4379 44C42.4379 44 36.0744 33.9038 41.1692 24C46.8624 12.9336 42.2078 4 42.2078 4L7.01134 4C7.01134 4 11.6577 12.932 5.96912 23.9969C0.876273 33.9029 7.27094 44 7.27094 44L42.4379 44Z"
                    fill="currentColor"
                  ></path>
                </svg>
              </div>
              <h2 class="text-white text-lg font-bold leading-tight tracking-[-0.015em]">RecruitPro</h2>
            </div>
            <p class="hidden text-sm text-[#92adc9] md:block">
              {% if project %}Connected to {{ project.name }}{% else %}Select a project to view live data{% endif %}
            </p>
          </div>
          {% if user %}
          <p class="text-sm text-[#92adc9]">{{ user.email }}</p>
          {% endif %}
        </header>
        <!-- Page Content -->
        <main class="flex-1 overflow-y-auto p-8 bg-background-dark">
          <div class="max-w-7xl mx-auto flex flex-col gap-6">
            {% if error %}
            <div class="rounded-lg border border-red-500/40 bg-red-500/10 px-4 py-3 text-sm text-red-200">
              {{ error }}
            </div>
            {% endif %}

            {% if project %}
            <div class="flex flex-wrap justify-between items-start gap-4">
              <div class="flex flex-col gap-2">
                <p class="text-white text-4xl font-black leading-tight tracking-[-0.033em]">
                  {{ project.name }}{% if project.sector %} · {{ project.sector }}{% endif %}
                </p>
                <p class="text-[#92adc9] text-base font-normal leading-normal">
                  {% if project.client %}Client: {{ project.client }}{% else %}Internal project{% endif %}
                  {% if project.location_region %} • {{ project.location_region }}{% endif %}
                </p>
                {% if project.tags %}
                <div class="flex flex-wrap gap-2 pt-1">
                  {% for tag in project.tags %}
                  <span class="rounded-full border border-[#233648] px-3 py-1 text-xs text-[#92adc9]">{{ tag }}</span>
                  {% endfor %}
                </div>
                {% endif %}
              </div>
              <div class="flex flex-col items-end gap-2">
            <div class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-[#233648] px-4 transition-all duration-200 ease-out hover:shadow-lg hover:shadow-primary/20">
              <p class="text-white text-sm font-medium leading-normal">{{ project.status|title }}</p>
            </div>
                <p class="text-xs text-[#92adc9]">
                  Created {{ project.created_at.strftime('%Y-%m-%d %H:%M') if project.created_at else '—' }}
                </p>
              </div>
            </div>

            <div class="mt-4 flex flex-wrap items-center justify-between gap-3 rounded-lg border border-[#233648] bg-[#152433] px-4 py-3">
              <p class="text-sm font-medium text-white">Project actions</p>
              <div class="flex flex-wrap items-center gap-2">
                <a
                  class="rp-button inline-flex items-center gap-2 rounded-lg border border-primary/40 bg-primary/10 px-3 py-2 text-sm font-semibold text-primary hover:bg-primary/20"
                  href="#document-upload-form"
                >
                  <span class="material-symbols-outlined text-base" aria-hidden="true">upload_file</span>
                  Upload document
                </a>
                <a
                  class="rp-button inline-flex items-center gap-2 rounded-lg border border-primary/40 bg-primary/10 px-3 py-2 text-sm font-semibold text-primary hover:bg-primary/20"
                  href="#candidate-cv-form"
                >
                  <span class="material-symbols-outlined text-base" aria-hidden="true">description</span>
                  Add candidate CV
                </a>
                <button
                  class="rp-button inline-flex items-center gap-2 rounded-lg border border-rose-500/40 bg-rose-600/20 px-3 py-2 text-sm font-semibold text-rose-200 hover:bg-rose-600/30"
                  data-action="delete-project"
                  type="button"
                >
                  <span class="material-symbols-outlined text-base" aria-hidden="true">delete_forever</span>
                  <span data-button-label>Delete project</span>
                </button>
              </div>
            </div>

            <div
              id="project-actions-feedback"
              class="mt-3 hidden rounded-lg border px-4 py-2 text-sm"
              role="status"
            ></div>

            <section class="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
              <article class="rp-card p-4">
                <p class="text-xs text-[#92adc9]">Total positions</p>
                <p class="text-2xl font-semibold">{{ position_stats.total }}</p>
                <p class="text-xs text-[#92adc9]">Open: {{ position_stats.open }} • Draft: {{ position_stats.draft }} • Closed: {{ position_stats.closed }}</p>
              </article>
              <article class="rp-card p-4">
                <p class="text-xs text-[#92adc9]">Target hires</p>
                <p class="text-2xl font-semibold">{{ project.target_hires }}</p>
                <p class="text-xs text-[#92adc9]">Hires booked: {{ project.hires_count }}</p>
              </article>
              <article class="rp-card p-4">
                <p class="text-xs text-[#92adc9]">Candidates tracked</p>
                <p class="text-2xl font-semibold">{{ candidate_summary.total }}</p>
                {% set lead_status = (candidate_summary.by_status[0].status if candidate_summary.by_status else 'n/a') %}
                <p class="text-xs text-[#92adc9]">Top status: {{ lead_status }}</p>
              </article>
              <article class="rp-card p-4">
                <p class="text-xs text-[#92adc9]">Team members</p>
                <p class="text-2xl font-semibold">{{ project.team_members|length }}</p>
                <p class="text-xs text-[#92adc9]">{{ ', '.join(project.team_members) if project.team_members else 'No collaborators yet' }}</p>
              </article>
            </section>

            <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
              <section class="lg:col-span-2 flex flex-col gap-4">
                <article class="rp-card p-6 flex flex-col gap-3">
                  <header class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold">Project brief</h3>
                    {% if project.summary %}
                    <span class="text-xs text-[#92adc9]">Summary provided</span>
                    {% endif %}
                  </header>
                  <p class="text-sm text-[#92adc9] leading-relaxed">
                    {{ project.summary or 'Add a project summary from the RecruitPro console to give your team context.' }}
                  </p>
                  {% if project.team_members %}
                  <div class="flex flex-wrap gap-2 pt-2">
                    {% for member in project.team_members %}
                    <span class="rounded-full bg-[#233648] px-3 py-1 text-xs text-[#c2d7ef]">{{ member }}</span>
                    {% endfor %}
                  </div>
                  {% endif %}
                </article>

                <article class="rp-card p-6">
                  <header class="flex items-center justify-between pb-3">
                    <h3 class="text-lg font-semibold">Open positions</h3>
                    <a
                      class="text-sm font-medium text-primary hover:underline"
                      href="/project-positions?project_id={{ project.project_id }}{% if token %}&token={{ token }}{% endif %}"
                    >
                      Manage positions
                    </a>
                  </header>
                  {% if positions %}
                  <ul class="flex flex-col divide-y divide-[#233648]">
                    {% for position in positions[:6] %}
                    <li class="py-3 flex flex-col gap-1 transition-all duration-200 ease-out hover:-translate-y-0.5">
                      <div class="flex items-center justify-between">
                        <p class="text-sm font-semibold">{{ position.title }}</p>
                        <span class="rounded-full bg-[#233648] px-2 py-0.5 text-xs text-[#c2d7ef]">{{ position.status|title }}</span>
                      </div>
                      <p class="text-xs text-[#92adc9]">
                        {% if position.department %}{{ position.department }} · {% endif %}
                        {% if position.location %}{{ position.location }}{% else %}Location TBD{% endif %}
                      </p>
                      <p class="text-xs text-[#92adc9]">Openings: {{ position.openings }} · Applicants: {{ position.applicants_count }}</p>
                    </li>
                    {% endfor %}
                  </ul>
                  {% else %}
                  <p class="text-sm text-[#92adc9]">No positions yet. Create one from the RecruitPro console.</p>
                  {% endif %}
                </article>

                <article class="rp-card p-6">
                  <header class="flex items-center justify-between pb-3">
                    <h3 class="text-lg font-semibold">Candidate pipeline</h3>
                  </header>
                  {% if candidate_summary.total > 0 %}
                  <ul class="grid gap-3 sm:grid-cols-2">
                    {% for status in candidate_summary.by_status %}
                    <li class="rounded-lg border border-[#233648] bg-[#152433] p-3 transition-all duration-200 ease-out hover:-translate-y-0.5 hover:border-primary/40 hover:shadow-lg hover:shadow-primary/20">
                      <p class="text-xs text-[#92adc9] uppercase">{{ status.status }}</p>
                      <p class="text-xl font-semibold">{{ status.count }}</p>
                    </li>
                    {% endfor %}
                  </ul>
                  <div class="pt-4">
                    <h4 class="text-sm font-semibold text-white">Recent candidates</h4>
                    <ul class="mt-2 flex flex-col gap-2">
                      {% for item in candidate_summary.recent %}
                      <li class="flex flex-col rounded-lg border border-[#233648] bg-[#152433] p-3 text-sm transition-all duration-200 ease-out hover:-translate-y-0.5 hover:border-primary/40 hover:shadow-lg hover:shadow-primary/20">
                        <div class="flex items-center justify-between gap-2">
                          <span class="font-medium">{{ item.name }}</span>
                          <span class="text-xs text-[#92adc9]">{{ item.status|title }}</span>
                        </div>
                        <div class="flex items-center justify-between gap-2 text-xs text-[#92adc9]">
                          <span>{{ item.source or 'Unknown source' }}</span>
                          <a
                            class="text-primary hover:underline"
                            href="/candidate-profile?candidate_id={{ item.candidate_id }}{% if token %}&token={{ token }}{% endif %}"
                            target="_blank"
                            rel="noreferrer"
                          >
                            View profile
                          </a>
                        </div>
                      </li>
                      {% endfor %}
                    </ul>
                  </div>
                  {% else %}
                  <p class="text-sm text-[#92adc9]">Add candidates to this project to see pipeline insights.</p>
                  {% endif %}
                </article>
              </section>

              <section class="flex flex-col gap-4">
                <article class="rp-card p-6">
                  <header class="flex items-center justify-between pb-3">
                    <h3 class="text-lg font-semibold">Project documents</h3>
                    <span class="text-xs text-[#92adc9]">Uploaded files trigger AI analysis</span>
                  </header>
                  <form id="document-upload-form" class="flex flex-col gap-3" enctype="multipart/form-data">
                    <div class="flex flex-col gap-1">
                      <label class="text-xs font-medium text-[#c2d7ef]" for="document-upload-file">Select file</label>
                      <input
                        class="rounded-lg border border-[#233648] bg-[#152433] px-3 py-2 text-sm text-white file:mr-3 file:rounded-md file:border-0 file:bg-primary/20 file:px-3 file:py-2 file:text-sm file:font-semibold file:text-primary focus:border-primary/50 focus:ring-2 focus:ring-primary/40"
                        id="document-upload-file"
                        name="file"
                        required
                        type="file"
                      />
                    </div>
                    <div class="flex flex-col gap-1">
                      <label class="text-xs font-medium text-[#c2d7ef]" for="document-upload-name">Display name (optional)</label>
                      <input
                        class="rounded-lg border border-[#233648] bg-[#152433] px-3 py-2 text-sm text-white focus:border-primary/50 focus:ring-2 focus:ring-primary/40"
                        id="document-upload-name"
                        name="display_name"
                        placeholder="Project brief.pdf"
                        type="text"
                      />
                    </div>
                    <div class="flex items-center justify-end gap-2">
                      <button
                        class="rp-button inline-flex items-center gap-2 rounded-lg bg-primary px-4 py-2 text-sm font-semibold text-white"
                        data-loading-label="Uploading..."
                        type="submit"
                      >
                        <span class="material-symbols-outlined text-base" aria-hidden="true">cloud_upload</span>
                        <span data-button-label>Upload to project</span>
                      </button>
                    </div>
                  </form>
                  <div
                    id="document-upload-feedback"
                    class="mt-3 hidden rounded-lg border px-4 py-2 text-sm"
                    role="status"
                  ></div>
                  <ul
                    id="project-documents-list"
                    class="mt-4 flex flex-col gap-2 {% if not documents %}hidden{% endif %}"
                  >
                    {% for doc in documents %}
                    <li class="flex flex-col rounded-lg border border-[#233648] bg-[#152433] p-3 text-sm transition-all duration-200 ease-out hover:-translate-y-0.5 hover:border-primary/40 hover:shadow-lg hover:shadow-primary/20">
                      <span class="font-medium">{{ doc.filename }}</span>
                      <span class="text-xs text-[#92adc9]">Uploaded {{ doc.uploaded_at.strftime('%Y-%m-%d %H:%M') if doc.uploaded_at else 'recently' }}</span>
                      {% if doc.url %}
                      <a class="text-xs text-primary hover:underline" href="{{ doc.url }}" target="_blank" rel="noreferrer">Open file</a>
                      {% endif %}
                    </li>
                    {% endfor %}
                  </ul>
                  <p
                    id="project-documents-empty"
                    class="mt-4 text-sm text-[#92adc9] {% if documents %}hidden{% endif %}"
                  >
                    No documents uploaded yet. Use the uploader above to attach project assets and trigger AI analysis.
                  </p>
                </article>

                <article class="rp-card p-6">
                  <h3 class="text-lg font-semibold">Market research</h3>
                  {% if market_research %}
                  <p class="text-sm text-[#92adc9]">Status: {{ market_research.status|title }} · {{ market_research.region }} · {{ market_research.window }}</p>
                  <p class="pt-1 text-xs text-[#92adc9]">Completed {{ market_research.completed_at.strftime('%Y-%m-%d %H:%M') if market_research.completed_at else 'recently' }}</p>
                  {% if market_research.findings %}
                  <ul class="mt-3 list-disc pl-5 text-sm text-[#c2d7ef]">
                    {% for item in market_research.findings %}
                    <li>{{ item }}</li>
                    {% endfor %}
                  </ul>
                  {% endif %}
                  {% else %}
                  <p class="text-sm text-[#92adc9]">Run AI research from the console to generate competitive insights.</p>
                  {% endif %}
                </article>

                <article class="rp-card p-6">
                  <header class="flex flex-col gap-1 pb-3">
                    <h3 class="text-lg font-semibold">Add candidate via CV</h3>
                    <p class="text-xs text-[#92adc9]">Upload a resume to create a new candidate record for this project.</p>
                  </header>
                  <form id="candidate-cv-form" class="flex flex-col gap-3">
                    <div class="flex flex-col gap-1">
                      <label class="text-xs font-medium text-[#c2d7ef]" for="candidate-cv-file">Resume file</label>
                      <input
                        class="rounded-lg border border-[#233648] bg-[#152433] px-3 py-2 text-sm text-white file:mr-3 file:rounded-md file:border-0 file:bg-primary/20 file:px-3 file:py-2 file:text-sm file:font-semibold file:text-primary focus:border-primary/50 focus:ring-2 focus:ring-primary/40"
                        id="candidate-cv-file"
                        name="resume"
                        required
                        type="file"
                      />
                    </div>
                    <div class="grid gap-3 md:grid-cols-2">
                      <div class="flex flex-col gap-1">
                        <label class="text-xs font-medium text-[#c2d7ef]" for="candidate-cv-name">Candidate name</label>
                        <input
                          class="rounded-lg border border-[#233648] bg-[#152433] px-3 py-2 text-sm text-white focus:border-primary/50 focus:ring-2 focus:ring-primary/40"
                          id="candidate-cv-name"
                          name="candidate_name"
                          placeholder="Alex Johnson"
                          required
                          type="text"
                        />
                      </div>
                      <div class="flex flex-col gap-1">
                        <label class="text-xs font-medium text-[#c2d7ef]" for="candidate-cv-email">Email (optional)</label>
                        <input
                          class="rounded-lg border border-[#233648] bg-[#152433] px-3 py-2 text-sm text-white focus:border-primary/50 focus:ring-2 focus:ring-primary/40"
                          id="candidate-cv-email"
                          name="candidate_email"
                          placeholder="alex@example.com"
                          type="email"
                        />
                      </div>
                    </div>
                    <div class="grid gap-3 md:grid-cols-2">
                      <div class="flex flex-col gap-1">
                        <label class="text-xs font-medium text-[#c2d7ef]" for="candidate-cv-position">Assign to position</label>
                        <select
                          class="rounded-lg border border-[#233648] bg-[#152433] px-3 py-2 text-sm text-white focus:border-primary/50 focus:ring-2 focus:ring-primary/40"
                          id="candidate-cv-position"
                          name="candidate_position"
                        >
                          <option value="">Unassigned</option>
                          {% for position in positions %}
                          <option value="{{ position.position_id }}">{{ position.title }}</option>
                          {% endfor %}
                        </select>
                      </div>
                      <div class="flex flex-col gap-1">
                        <label class="text-xs font-medium text-[#c2d7ef]" for="candidate-cv-source">Source label</label>
                        <input
                          class="rounded-lg border border-[#233648] bg-[#152433] px-3 py-2 text-sm text-white focus:border-primary/50 focus:ring-2 focus:ring-primary/40"
                          id="candidate-cv-source"
                          name="candidate_source"
                          placeholder="Resume upload"
                          type="text"
                          value="Resume upload"
                        />
                      </div>
                    </div>
                    <div class="flex items-center justify-end gap-2">
                      <button
                        class="rp-button inline-flex items-center gap-2 rounded-lg bg-primary px-4 py-2 text-sm font-semibold text-white"
                        data-loading-label="Saving..."
                        type="submit"
                      >
                        <span class="material-symbols-outlined text-base" aria-hidden="true">person_add</span>
                        <span data-button-label>Create candidate</span>
                      </button>
                    </div>
                  </form>
                  <div
                    id="candidate-cv-feedback"
                    class="mt-3 hidden rounded-lg border px-4 py-2 text-sm"
                    role="status"
                  ></div>
                </article>

                <article class="rp-card p-6">
                  <h3 class="text-lg font-semibold">AI screening</h3>
                  {% if ai_screening %}
                  <p class="text-sm text-[#92adc9]">Latest run {{ ai_screening.status|title }} on {{ ai_screening.created_at.strftime('%Y-%m-%d %H:%M') if ai_screening.created_at else '—' }}</p>
                  {% if ai_screening.updated_at %}
                  <p class="text-xs text-[#92adc9]">Updated {{ ai_screening.updated_at.strftime('%Y-%m-%d %H:%M') }}</p>
                  {% endif %}
                  {% else %}
                  <p class="text-sm text-[#92adc9]">No AI screening activity yet. Trigger screening from the RecruitPro console.</p>
                  {% endif %}
                </article>

                <article class="rp-card p-6">
                  <h3 class="text-lg font-semibold">Recent activity</h3>
                  {% if recent_activity %}
                  <ul class="mt-3 flex flex-col gap-2 text-sm">
                    {% for item in recent_activity %}
                    <li class="rounded-lg border border-[#233648] bg-[#152433] p-3 transition-all duration-200 ease-out hover:-translate-y-0.5 hover:border-primary/40 hover:shadow-lg hover:shadow-primary/20">
                      <p>{{ item.message }}</p>
                      <p class="text-xs text-[#92adc9]">{{ item.event_type }} · {{ item.created_at.strftime('%Y-%m-%d %H:%M') if item.created_at else '—' }}</p>
                    </li>
                    {% endfor %}
                  </ul>
                  {% else %}
                  <p class="text-sm text-[#92adc9]">Activity will appear here after you interact with the project.</p>
                  {% endif %}
                </article>
              </section>
            </div>
            {% else %}
            <div class="rp-card p-10 text-center text-[#92adc9]">
              Provide a <code class="rounded bg-[#233648] px-2 py-1 text-white">project_id</code> and a valid <code class="rounded bg-[#233648] px-2 py-1 text-white">token</code> query parameter to load a project overview.
            </div>
            {% endif %}
          </div>
        </main>
      </div>
    </div>
  </body>
  {% if project %}
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const PROJECT_ID = {{ project.project_id|tojson }};
      const EMBEDDED_TOKEN = {{ token|tojson }};
      const TOKEN_STORAGE_KEY = "recruitpro.token";
      const TOKEN_TYPE_STORAGE_KEY = "recruitpro.tokenType";

      const FEEDBACK_VARIANTS = {
        success: ["border-emerald-400/40", "bg-emerald-400/10", "text-emerald-200"],
        error: ["border-rose-400/60", "bg-rose-400/10", "text-rose-200"],
        info: ["border-sky-400/40", "bg-sky-400/10", "text-sky-200"],
      };

      function clearFeedback(element) {
        if (!element) return;
        element.classList.add("hidden");
        element.textContent = "";
        Object.values(FEEDBACK_VARIANTS).forEach((classes) => element.classList.remove(...classes));
      }

      function showFeedback(element, type, message) {
        if (!element) return;
        clearFeedback(element);
        const classes = FEEDBACK_VARIANTS[type] || [];
        if (classes.length) {
          element.classList.add(...classes);
        }
        element.textContent = message;
        element.classList.remove("hidden");
      }

      function getStoredToken() {
        try {
          return window.localStorage?.getItem(TOKEN_STORAGE_KEY) || null;
        } catch (error) {
          return null;
        }
      }

      function getStoredTokenType() {
        try {
          return window.localStorage?.getItem(TOKEN_TYPE_STORAGE_KEY) || "Bearer";
        } catch (error) {
          return "Bearer";
        }
      }

      function getAuthHeader() {
        if (EMBEDDED_TOKEN) {
          return `Bearer ${EMBEDDED_TOKEN}`;
        }
        const stored = getStoredToken();
        if (!stored) {
          return null;
        }
        const tokenType = getStoredTokenType() || "Bearer";
        return `${tokenType} ${stored}`.trim();
      }

      async function apiFetch(path, options = {}) {
        const init = { credentials: "include", ...options };
        init.headers = new Headers(init.headers || {});
        const authHeader = getAuthHeader();
        if (authHeader && !init.headers.has("Authorization")) {
          init.headers.set("Authorization", authHeader);
        }
        if (init.body && typeof init.body === "object" && !(init.body instanceof FormData)) {
          init.headers.set("Content-Type", "application/json");
          init.body = JSON.stringify(init.body);
        }
        if (!init.headers.has("Accept")) {
          init.headers.set("Accept", "application/json");
        }
        const response = await fetch(path, init);
        const text = await response.text();
        let data = null;
        if (text) {
          try {
            data = JSON.parse(text);
          } catch (error) {
            data = text;
          }
        }
        if (!response.ok) {
          const detail = typeof data === "string" ? data : data?.detail || data?.message;
          const error = new Error(detail || `Request failed with status ${response.status}`);
          error.status = response.status;
          error.payload = data;
          throw error;
        }
        return data;
      }

      function formatDateTime(value) {
        if (!value) {
          return "recently";
        }
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) {
          return "recently";
        }
        return new Intl.DateTimeFormat(undefined, {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
        }).format(date);
      }

      function createDocumentElement(data) {
        const item = document.createElement("li");
        item.className = "flex flex-col rounded-lg border border-[#233648] bg-[#152433] p-3 text-sm transition-all duration-200 ease-out hover:-translate-y-0.5 hover:border-primary/40 hover:shadow-lg hover:shadow-primary/20";
        const title = document.createElement("span");
        title.className = "font-medium";
        title.textContent = data.filename || "Document";
        item.appendChild(title);
        const meta = document.createElement("span");
        meta.className = "text-xs text-[#92adc9]";
        meta.textContent = `Uploaded ${formatDateTime(data.uploaded_at)}`;
        item.appendChild(meta);
        const url = data.file_url || data.url;
        if (url) {
          const link = document.createElement("a");
          link.className = "text-xs text-primary hover:underline";
          link.target = "_blank";
          link.rel = "noreferrer";
          link.href = url;
          link.textContent = "Open file";
          item.appendChild(link);
        }
        return item;
      }

      function renderDocuments(docs) {
        const list = document.getElementById("project-documents-list");
        const emptyState = document.getElementById("project-documents-empty");
        if (!list || !emptyState) {
          return;
        }
        list.innerHTML = "";
        const items = (docs || []).slice(0, 6);
        if (!items.length) {
          list.classList.add("hidden");
          emptyState.classList.remove("hidden");
          return;
        }
        items.forEach((doc) => {
          const storedPath = typeof doc.file_url === "string" ? doc.file_url : "";
          const isExternal = /^https?:/i.test(storedPath);
          const normalized = {
            filename: doc.filename,
            uploaded_at: doc.uploaded_at,
            file_url: doc.url || (storedPath ? (isExternal ? storedPath : `/storage/${storedPath.replace(/^\/+/, "")}`) : undefined),
          };
          list.appendChild(createDocumentElement(normalized));
        });
        emptyState.classList.add("hidden");
        list.classList.remove("hidden");
      }

      async function refreshDocuments(feedbackTarget) {
        try {
          const response = await apiFetch(`/api/projects/${encodeURIComponent(PROJECT_ID)}/documents`);
          renderDocuments(response);
        } catch (error) {
          if (feedbackTarget) {
            showFeedback(feedbackTarget, "error", error.message || "Failed to refresh documents.");
          }
        }
      }

      function setButtonLoading(button, loading) {
        if (!button) return;
        const label = button.querySelector("[data-button-label]");
        if (loading) {
          button.dataset.originalDisabled = button.disabled ? "true" : "false";
          button.dataset.originalLabel = label ? label.textContent : "";
          const loadingLabel = button.dataset.loadingLabel || "Working...";
          if (label) {
            label.textContent = loadingLabel;
          }
          button.disabled = true;
        } else {
          if (label && Object.prototype.hasOwnProperty.call(button.dataset, "originalLabel")) {
            label.textContent = button.dataset.originalLabel;
          }
          if (button.dataset.originalDisabled === "false") {
            button.disabled = false;
          }
          delete button.dataset.originalDisabled;
          delete button.dataset.originalLabel;
        }
      }

      const documentForm = document.getElementById("document-upload-form");
      const documentFeedback = document.getElementById("document-upload-feedback");
      if (documentForm) {
        documentForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          clearFeedback(documentFeedback);
          const fileInput = documentForm.querySelector('input[name="file"]');
          if (!fileInput || !fileInput.files || !fileInput.files.length) {
            showFeedback(documentFeedback, "error", "Choose a file before uploading.");
            return;
          }
          const file = fileInput.files[0];
          const nameField = documentForm.querySelector('input[name="display_name"]');
          const displayName = (nameField && nameField.value.trim()) || file.name;
          const formData = new FormData();
          formData.append("filename", displayName);
          formData.append("mime_type", file.type || "application/octet-stream");
          formData.append("scope", "project");
          formData.append("scope_id", PROJECT_ID);
          formData.append("file", file);
          const submitButton = documentForm.querySelector('button[type="submit"]');
          try {
            setButtonLoading(submitButton, true);
            await apiFetch("/api/documents/upload", { method: "POST", body: formData });
            documentForm.reset();
            showFeedback(documentFeedback, "success", "Document uploaded successfully. AI analysis has been queued.");
            await refreshDocuments(documentFeedback);
          } catch (error) {
            showFeedback(documentFeedback, "error", error.message || "Failed to upload document.");
          } finally {
            setButtonLoading(submitButton, false);
          }
        });
      }

      const candidateForm = document.getElementById("candidate-cv-form");
      const candidateFeedback = document.getElementById("candidate-cv-feedback");
      if (candidateForm) {
        candidateForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          clearFeedback(candidateFeedback);
          const fileInput = candidateForm.querySelector('input[name="resume"]');
          if (!fileInput || !fileInput.files || !fileInput.files.length) {
            showFeedback(candidateFeedback, "error", "Select a resume file to continue.");
            return;
          }
          const resumeFile = fileInput.files[0];
          const nameInput = candidateForm.querySelector('input[name="candidate_name"]');
          const emailInput = candidateForm.querySelector('input[name="candidate_email"]');
          const positionInput = candidateForm.querySelector('select[name="candidate_position"]');
          const sourceInput = candidateForm.querySelector('input[name="candidate_source"]');

          const candidateName = nameInput?.value.trim();
          if (!candidateName) {
            showFeedback(candidateFeedback, "error", "Provide the candidate name.");
            return;
          }

          const submitButton = candidateForm.querySelector('button[type="submit"]');

          try {
            setButtonLoading(submitButton, true);
            const uploadForm = new FormData();
            uploadForm.append("filename", resumeFile.name || `${candidateName}-resume`);
            uploadForm.append("mime_type", resumeFile.type || "application/pdf");
            uploadForm.append("scope", "project");
            uploadForm.append("scope_id", PROJECT_ID);
            uploadForm.append("file", resumeFile);
            const uploaded = await apiFetch("/api/documents/upload", { method: "POST", body: uploadForm });
            const resumeUrl = uploaded?.file_url ? `/storage/${uploaded.file_url.replace(/^\/+/, "")}` : null;
            const payload = {
              name: candidateName,
              project_id: PROJECT_ID,
              position_id: positionInput?.value || null,
              email: emailInput?.value || null,
              source: sourceInput?.value?.trim() || "Resume upload",
              status: "new",
              resume_url: resumeUrl,
            };
            if (!payload.email) {
              delete payload.email;
            }
            if (!payload.position_id) {
              delete payload.position_id;
            }
            if (!payload.resume_url) {
              delete payload.resume_url;
            }
            const created = await apiFetch("/api/candidates", { method: "POST", body: payload });
            candidateForm.reset();
            const tokenQuery = EMBEDDED_TOKEN ? `&token=${encodeURIComponent(EMBEDDED_TOKEN)}` : "";
            const profileLink = created?.candidate_id
              ? `/candidate-profile?candidate_id=${encodeURIComponent(created.candidate_id)}${tokenQuery}`
              : null;
            if (profileLink) {
              showFeedback(candidateFeedback, "success", "Candidate created successfully.");
              const link = document.createElement("a");
              link.className = "ml-1 underline text-primary";
              link.href = profileLink;
              link.target = "_blank";
              link.rel = "noreferrer";
              link.textContent = "Open profile";
              candidateFeedback.appendChild(document.createTextNode(" "));
              candidateFeedback.appendChild(link);
            } else {
              showFeedback(candidateFeedback, "success", "Candidate created successfully.");
            }
          } catch (error) {
            showFeedback(candidateFeedback, "error", error.message || "Failed to add candidate.");
          } finally {
            setButtonLoading(submitButton, false);
          }
        });
      }

      const deleteButton = document.querySelector('[data-action="delete-project"]');
      const actionFeedback = document.getElementById("project-actions-feedback");
      if (deleteButton) {
        deleteButton.addEventListener("click", async () => {
          if (!window.confirm("Deleting this project will remove associated data. Continue?")) {
            return;
          }
          clearFeedback(actionFeedback);
          try {
            setButtonLoading(deleteButton, true);
            await apiFetch(`/api/projects/${encodeURIComponent(PROJECT_ID)}`, { method: "DELETE" });
            showFeedback(actionFeedback, "success", "Project deleted. Redirecting to dashboard...");
            const redirectToken = EMBEDDED_TOKEN ? `?token=${encodeURIComponent(EMBEDDED_TOKEN)}` : "";
            window.setTimeout(() => {
              window.location.href = `/app${redirectToken}`;
            }, 1200);
          } catch (error) {
            showFeedback(actionFeedback, "error", error.message || "Failed to delete project.");
          } finally {
            setButtonLoading(deleteButton, false);
          }
        });
      }
    });
  </script>
  {% endif %}
</html>
